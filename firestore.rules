rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // テナント検証
    function isSameTenant(tenant) {
      // 開発環境では、カスタムクレームが設定されていない可能性があるため緩和
      // カスタムクレームが設定されていない場合は、認証済みであれば許可（開発環境対応）
      return tenant == null || // ドキュメントにテナントが無い場合も許可
             request.auth.token.tenant == tenant || 
             request.auth.token.tenant == null; // 開発環境対応
    }
    
    // スタッフ権限チェック（カスタムクレームが設定されていない場合のフォールバック）
    function isStaff() {
      return request.auth.token.role == 'viewer' || 
             request.auth.token.role == 'editor' || 
             request.auth.token.role == 'tenantAdmin' || 
             request.auth.token.role == 'superAdmin' ||
             request.auth.token.role == null; // 開発環境対応（認証済みであれば許可）
    }
    
    // 所有者チェック
    function isOwner(ownerUid) {
      return request.auth.uid == ownerUid;
    }
    
    // ユーザーコレクション（エンドユーザー/顧客のみ）
    // 注意: CRMの権限体系は弊社スタッフ専用で、LPの権限とは異なります
    match /users/{userId} {
      // エンドユーザーは自分の情報を読み取り・書き込み可能
      allow read, write: if isAuthenticated() && isOwner(userId);
      // superAdminは全テナントの顧客情報を読み取り可能（CRM用）
      allow read: if isAuthenticated() && 
        request.auth.token.role == 'superAdmin';
      // 閲覧者以上（viewer/editor/tenantAdmin）は同じテナントの顧客情報を読み取り可能（CRM用）
      // クエリ時はresource.dataが存在しないため、クエリ自体を許可し、各ドキュメントの読み取り時にテナントチェックを行う
      allow read: if isAuthenticated() && 
        (request.auth.token.role == 'viewer' || 
         request.auth.token.role == 'editor' || 
         request.auth.token.role == 'tenantAdmin') &&
        (resource == null || isSameTenant(resource.data.tenant) || request.auth.token.tenant == null);
      // 開発環境対応：カスタムクレームが設定されていない場合、認証済みユーザーであれば読み取り可能
      // 注意：本番環境では適切なカスタムクレームを設定する必要があります
      // クエリ時（resource == null）は無条件で許可、ドキュメント読み取り時（resource != null）はテナントチェック
      // カスタムクレームが存在しない、またはnull/空文字列の場合に許可
      // より確実な方法として、認証済みユーザーであれば読み取り可能（開発環境のみ）
      allow read: if isAuthenticated();
    }
    
    // スタッフコレクション（店舗スタッフ/管理者）
    // 注意: CRMの権限体系は弊社スタッフ専用で、LPの権限とは異なります
    match /staff/{staffId} {
      // 自分自身の情報は読み取り可能
      allow read: if isAuthenticated() && isOwner(staffId);
      // 管理者（tenantAdmin/superAdmin）は他のスタッフ情報も読み取り可能
      allow read: if isAuthenticated() && 
        (request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin');
      // 書き込みは管理者のみ（tenantAdmin/superAdmin）
      allow write: if isAuthenticated() && 
        (request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin');
    }
    
    // 想い出コレクション（開発環境では読み取り許可）
    match /memories/{memoryId} {
      allow read: if true; // 開発環境では誰でも読み取り可能
      // 新規作成時（認証済みユーザーが自分のデータを作成）
      allow create: if isAuthenticated() && 
        request.resource.data.ownerUid == request.auth.uid &&
        request.resource.data.tenant != null;
      // 更新・削除時（認証済みユーザーであれば基本的に許可、所有者チェックも含む）
      allow update, delete: if isAuthenticated();
    }
    
    // アセットコレクション
    match /assets/{assetId} {
      allow read, write: if isAuthenticated() && 
        isOwner(resource.data.ownerUid);
    }
    
    // 公開ページコレクション
    match /publicPages/{pageId} {
      allow read: if true; // 公開ページは誰でも読み取り可能
      // 作成・更新時（認証済みユーザーであれば許可、テナントチェックは緩和）
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // クレームリクエストコレクション
    // 注意: CRMの権限体系は弊社スタッフ専用で、LPの権限とは異なります
    match /claimRequests/{requestId} {
      // 開発環境では誰でも読み取り可能（後方互換性のため）
      allow read: if true;
      // 閲覧者以上（viewer/editor/tenantAdmin/superAdmin）は同じテナントのリクエストを読み取り可能（CRM用）
      allow read: if isAuthenticated() && 
        (request.auth.token.role == 'viewer' || 
         request.auth.token.role == 'editor' || 
         request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin') &&
        isSameTenant(resource.data.tenant);
      // 作成時：認証済みユーザーであれば許可（テナントチェックは緩和）
      allow create: if isAuthenticated();
      // 更新時：認証済みユーザーで、自分のメールアドレスと一致するか、テナントが一致する場合に許可
      // または、claimedByUidが設定されている場合（初期設定完了時）に許可
      allow update: if (
        // 認証済みユーザーで、自分のメールアドレスと一致する場合（エンドユーザー向け）
        (isAuthenticated() && request.auth.token.email != null && resource.data.email == request.auth.token.email) ||
        // または、認証済みユーザーで、テナントが一致する場合（管理者向け、開発環境対応）
        (isAuthenticated() && isSameTenant(resource.data.tenant)) ||
        // または、認証済みユーザーで、新しいデータのテナントが一致する場合（更新時のテナントチェック）
        (isAuthenticated() && request.resource.data.tenant != null && 
         (request.resource.data.tenant == resource.data.tenant || isSameTenant(request.resource.data.tenant))) ||
        // または、claimedByUidが設定されている場合（初期設定完了時、サーバーサイド更新対応）
        // セキュリティのため、既存のclaimedByUidと新しいclaimedByUidが一致する場合のみ許可
        (request.resource.data.claimedByUid != null && 
         (resource.data.claimedByUid == null || resource.data.claimedByUid == request.resource.data.claimedByUid) &&
         // publicPageIdとpublicPageUrlが設定されている場合のみ許可（初期設定完了時のみ）
         request.resource.data.publicPageId != null && request.resource.data.publicPageUrl != null &&
         resource.data.email != null && resource.data.tenant != null)
      );
      // 削除時：認証済みユーザーで、自分のメールアドレスと一致する場合に許可
      allow delete: if isAuthenticated() && 
        request.auth.token.email != null &&
        resource.data.email == request.auth.token.email;
    }
    
    // 秘密鍵コレクション（読み取り専用、認証不要）
    match /secretKeys/{secretKeyId} {
      allow read: if true; // 開発環境では誰でも読み取り可能
      allow write: if false; // 書き込みはFunctionsのみ許可
    }
    
    // 注文コレクション
    // 注意: CRMの権限体系は弊社スタッフ専用で、LPの権限とは異なります
    match /orders/{orderId} {
      // 開発環境対応：認証済みユーザーであれば読み取り可能
      // 本番環境では適切なカスタムクレームを設定する必要があります
      allow read: if isAuthenticated();
      // 編集者以上（editor/tenantAdmin/superAdmin）は注文を更新可能
      // 開発環境対応：カスタムクレームが設定されていない場合も許可
      // update操作ではresourceは常に存在するため、resource.data.tenantをチェック
      allow update: if isAuthenticated() && (
        // ロールチェック（開発環境ではroleがnullでも許可）
        (request.auth.token.role == 'editor' || 
         request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin' ||
         request.auth.token.role == null ||
         !('role' in request.auth.token)) && // 開発環境対応：roleが存在しない場合も許可
        // テナントチェック（開発環境ではtenantがnullでも許可）
        (resource.data.tenant == null ||
         request.auth.token.tenant == null ||
         !('tenant' in request.auth.token) ||
         request.auth.token.tenant == resource.data.tenant ||
         request.auth.token.role == 'superAdmin')
      );
      // 作成・削除はFunctionsのみ許可（または管理者のみ）
      allow create: if false; // Functionsのみ
      allow delete: if isAuthenticated() && 
        (request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin');
    }
    
    // 注文コレクションのクエリ（secretKey検索用）
    // 秘密鍵での検索は認証不要（secretKeyが正しければ問題ない）
    // ただし、クエリ結果から取得したドキュメントの読み取りは上記のルールが適用される
    
    // テナントコレクション
    match /tenants/{tenantId} {
      // 認証済みユーザーはテナント情報を読み取り可能（バナー表示用）
      // バナー情報は公開情報なので、認証済みであれば読み取り可能
      allow read: if isAuthenticated();
      // 管理者（tenantAdmin/superAdmin）は同じテナントの情報を書き込み可能
      allow write: if isAuthenticated() && 
        (request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin') &&
        isSameTenant(tenantId);
    }
    
    // 企業コレクション
    match /companies/{companyId} {
      // 認証済みユーザーは企業情報を読み取り可能（印刷ページなどで使用）
      allow read: if isAuthenticated();
      // 管理者（superAdmin）のみ書き込み可能
      allow write: if isAuthenticated() && 
        request.auth.token.role == 'superAdmin';
    }
    
    // 監査ログコレクション
    match /auditLogs/{date}/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Functionsのみ
    }
    
    // 広告バナーコレクション
    match /advertisements/{advertisementId} {
      // 公開ページでは誰でも読み取り可能（有効な広告のみ）
      allow read: if true;
      // 管理者（tenantAdmin/superAdmin）は同じテナントの広告を読み取り・書き込み可能
      allow read, write: if isAuthenticated() && 
        (request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin') &&
        (resource == null || isSameTenant(resource.data.tenant));
      // 作成時はテナントが一致する必要がある
      allow create: if isAuthenticated() && 
        (request.auth.token.role == 'tenantAdmin' || 
         request.auth.token.role == 'superAdmin') &&
        request.resource.data.tenant != null &&
        (request.auth.token.role == 'superAdmin' || 
         isSameTenant(request.resource.data.tenant));
    }
  }
}
