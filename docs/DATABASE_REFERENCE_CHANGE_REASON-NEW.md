# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‚ç…§æ–¹æ³•ã®å¤‰æ›´ç†ç”±

## ğŸ“‹ æ¦‚è¦

ä»Šå›ã®ä½œæ¥­ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‚ç…§æ–¹æ³•ã‚’å¤‰æ›´ã—ãŸç†ç”±ã¨ã€å¤‰æ›´å‰å¾Œã®é•ã„ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ” å¤‰æ›´å‰ã®å•é¡Œç‚¹

### 1. **`companyId`ãŒ`unknown`ã«ãªã‚‹å•é¡Œ**

**å•é¡Œ**:
- ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«`companyId: 'unknown'`ãŒè¨­å®šã•ã‚Œã‚‹
- ãã®çµæœã€ä»¥ä¸‹ã®APIå‘¼ã³å‡ºã—ãŒå¤±æ•—ï¼š
  - çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆ400 Bad Requestï¼‰
  - ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆ404 Not Foundï¼‰
  - åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆ404 Not Foundï¼‰
  - é¡§å®¢æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆ404 Not Foundï¼‰

**åŸå› **:
- `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«`companyId`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„
- `staff`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®å–å¾—ã«å¯¾å¿œã—ã¦ã„ãªã„
- `adminTenant`ã‹ã‚‰`companyId`ã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸è¶³

### 2. **`orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`tenant`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸ä¸€è‡´**

**å•é¡Œ**:
- `orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`tenant`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒæ··åœ¨ï¼š
  - `tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆä¾‹: `emolink-direct-01`ï¼‰âœ… æ¨å¥¨
  - `companyId`ï¼ˆä¾‹: `emolink`ï¼‰âš ï¸ å¾Œæ–¹äº’æ›æ€§
  - Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆä¾‹: `store-1765044610296`ï¼‰âš ï¸ å¤ã„ãƒ‡ãƒ¼ã‚¿

**å½±éŸ¿**:
- `tenantId`ã§æ¤œç´¢ã—ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- `companyId`ã§æ¤œç´¢ã—ã¦ã‚‚ã€ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã—ã‹å–å¾—ã§ããªã„
- åŒã˜ä¼æ¥­ã®è¤‡æ•°åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ããªã„

### 3. **åº—èˆ—æƒ…å ±ã®ä¿å­˜å ´æ‰€ã®ä¸çµ±ä¸€**

**å•é¡Œ**:
- åº—èˆ—æƒ…å ±ãŒ`users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`stores`é…åˆ—ã«ã®ã¿ä¿å­˜
- `tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ã§ã¯`tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã™ã¹ãã¨ã•ã‚Œã¦ã„ã‚‹

**å½±éŸ¿**:
- åº—èˆ—æƒ…å ±ã®å–å¾—ãŒè¤‡é›‘ã«ãªã‚‹
- ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒä¿ã¦ãªã„
- ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’å–å¾—ã§ããªã„

### 4. **é¡§å®¢æƒ…å ±ã®å–å¾—å…ƒãŒä¸æ˜ç¢º**

**å•é¡Œ**:
- é¡§å®¢æƒ…å ±ã‚’ã©ã“ã‹ã‚‰å–å¾—ã™ã¹ãã‹ä¸æ˜ç¢º
- `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨`orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä½¿ã„åˆ†ã‘ãŒä¸æ˜ç¢º

**å½±éŸ¿**:
- é¡§å®¢ç®¡ç†æ©Ÿèƒ½ãŒå®Ÿè£…ã§ããªã„
- ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ã‚„ä¸æ•´åˆãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§

## âœ… å¤‰æ›´å¾Œã®æ”¹å–„ç‚¹

### 1. **`companyId`å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„**

**å¤‰æ›´å†…å®¹**:
```typescript
// å¤‰æ›´å‰: usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‹ã‚‰å–å¾—
const userDoc = await db.collection('users').doc(userId).get();

// å¤‰æ›´å¾Œ: usersã¨staffã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸¡æ–¹ã‹ã‚‰å–å¾—
let userRef = db.collection('users').doc(userId);
let userDoc = await userRef.get();

if (!userDoc.exists) {
  userRef = db.collection('staff').doc(userId);
  userDoc = await userRef.get();
}

// adminTenantã‹ã‚‰companyIdã‚’å–å¾—
const companyId = userData?.companyId || userData?.adminTenant;
```

**æ”¹å–„ç‚¹**:
- `staff`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®å–å¾—ã«å¯¾å¿œ
- `adminTenant`ã‹ã‚‰`companyId`ã‚’å–å¾—
- `stores`é…åˆ—ã‹ã‚‰`tenantId`ã‚’å–å¾—

### 2. **`tenantId`è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…**

**å¤‰æ›´å†…å®¹**:
```typescript
// å¤‰æ›´å‰: æä¾›ã•ã‚ŒãŸå€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨
const finalTenantId = tenantId || companyId;

// å¤‰æ›´å¾Œ: tenantsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è§£æ±º
const getTenantIdFromValue = async (value: string) => {
  // 1. idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ¤œç´¢ï¼ˆè­˜åˆ¥å¯èƒ½ãªIDã€ä¾‹: emolink-direct-01ï¼‰
  const tenantQueryById = tenantsRef.where('id', '==', value).limit(1);
  // 2. companyIdã§æ¤œç´¢
  const tenantQueryByCompany = tenantsRef.where('companyId', '==', value).limit(1);
  // 3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã§æ¤œç´¢ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
  const tenantDoc = await tenantsRef.doc(value).get();
  
  return tenantData?.id || tenantDoc.id;
};
```

**æ”¹å–„ç‚¹**:
- `tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
- è§£æ±ºã§ããªã„å ´åˆã¯ã€æä¾›ã•ã‚ŒãŸå€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- è¤‡æ•°ã®æ¤œç´¢æ–¹æ³•ã‚’è©¦è¡Œ

### 3. **è¤‡æ•°ãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œã®æ¤œç´¢**

**å¤‰æ›´å†…å®¹**:
```typescript
// å¤‰æ›´å‰: å˜ä¸€ã®tenantã§æ¤œç´¢
const snapshot = await db.collection('orders')
  .where('tenant', '==', finalTenantId)
  .get();

// å¤‰æ›´å¾Œ: companyIdãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€è¤‡æ•°ã®tenantã§æ¤œç´¢
if (companyId) {
  // tenantsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã™ã¹ã¦ã®tenantã‚’å–å¾—
  const tenantsQuery = tenantsRef.where('companyId', '==', companyId);
  const tenantIds = tenantsSnapshot.docs.map(doc => {
    return tenantData.id || doc.id;
  });
  
  // companyIdè‡ªä½“ã‚‚è¿½åŠ 
  tenantIds.push(companyId);
  
  // 10ä»¶ãšã¤ã«åˆ†å‰²ã—ã¦æ¤œç´¢ï¼ˆFirestoreã®`in`ã‚¯ã‚¨ãƒªã¯æœ€å¤§10ä»¶ã¾ã§ï¼‰
  for (let i = 0; i < tenantIds.length; i += 10) {
    const batch = tenantIds.slice(i, i + 10);
    const snapshot = await db.collection('orders')
      .where('tenant', 'in', batch)
      .get();
    // çµæœã‚’ãƒãƒ¼ã‚¸
  }
}
```

**æ”¹å–„ç‚¹**:
- åŒã˜ä¼æ¥­ã®è¤‡æ•°åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã«å–å¾—
- `orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«`companyId`ãŒç›´æ¥ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã‚‚å¯¾å¿œ
- ãƒ‡ãƒ¼ã‚¿ã®æ¼ã‚Œã‚’é˜²æ­¢

### 4. **`tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®åº—èˆ—æƒ…å ±ä¿å­˜**

**å¤‰æ›´å†…å®¹**:
```typescript
// å¤‰æ›´å‰: usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®storesé…åˆ—ã«ã®ã¿ä¿å­˜
await userRef.update({
  stores: stores,
  storeInfo: stores[0]
});

// å¤‰æ›´å¾Œ: tenantsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚‚ä¿å­˜
for (const store of stores) {
  const tenantRef = db.collection('tenants').doc(store.lpId);
  const tenantData = {
    id: store.lpId,              // è­˜åˆ¥å¯èƒ½ãªID
    companyId: companyId,        // æ‰€å±ä¼æ¥­ID
    name: store.storeName,      // åº—èˆ—å
    // ... ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  };
  await tenantRef.set(tenantData);
}
```

**æ”¹å–„ç‚¹**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ã«æº–æ‹ 
- åº—èˆ—æƒ…å ±ã®ä¸€å…ƒç®¡ç†
- ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã‚‚åº—èˆ—æƒ…å ±ã‚’å–å¾—å¯èƒ½

### 5. **é¡§å®¢æƒ…å ±å–å¾—å…ƒã®æ˜ç¢ºåŒ–**

**å¤‰æ›´å†…å®¹**:
```typescript
// å¤‰æ›´å‰: ä¸æ˜ç¢ºï¼ˆusersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸå¯èƒ½æ€§ï¼‰

// å¤‰æ›´å¾Œ: ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ï¼ˆæ˜ç¢ºåŒ–ï¼‰
const snapshot = await db.collection('orders')
  .where('tenant', '==', tenantId)
  .get();

// emailã§é‡è¤‡æ’é™¤
const customerMap = new Map<string, any>();
snapshot.docs.forEach(doc => {
  const orderData = doc.data();
  const email = orderData.email?.toLowerCase().trim();
  if (!customerMap.has(email) || 
      (orderData.createdAt && customerMap.get(email).latestOrderDate < orderData.createdAt)) {
    customerMap.set(email, {
      email: orderData.email,
      name: orderData.customerInfo?.name || '',
      phone: orderData.customerInfo?.phone || '',
      product: orderData.product || '',
      // ...
    });
  }
});
```

**æ”¹å–„ç‚¹**:
- é¡§å®¢æƒ…å ±ã®å–å¾—å…ƒã‚’`orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ˜ç¢ºåŒ–
- `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæƒ³ã„å‡ºãƒšãƒ¼ã‚¸ä½œæˆè€…ï¼‰ç”¨ã¨æ˜ç¢ºåŒ–
- ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡æ’é™¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…

## ğŸ“Š å¤‰æ›´å‰å¾Œã®æ¯”è¼ƒ

| é …ç›® | å¤‰æ›´å‰ | å¤‰æ›´å¾Œ |
|------|--------|--------|
| `companyId`å–å¾— | `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ | `users`ã¨`staff`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸¡æ–¹ã‹ã‚‰å–å¾— |
| `tenantId`è§£æ±º | æä¾›ã•ã‚ŒãŸå€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ | `tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è§£æ±ºã‚’è©¦ã¿ã‚‹ |
| é¡§å®¢æƒ…å ±å–å¾— | ä¸æ˜ç¢º | `orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ï¼ˆæ˜ç¢ºåŒ–ï¼‰ |
| åº—èˆ—æƒ…å ±ä¿å­˜ | `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ | `users`ã¨`tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸¡æ–¹ã«ä¿å­˜ |
| è¤‡æ•°ãƒ†ãƒŠãƒ³ãƒˆæ¤œç´¢ | éå¯¾å¿œ | `companyId`ã‹ã‚‰è¤‡æ•°ãƒ†ãƒŠãƒ³ãƒˆã‚’å–å¾—ã—ã¦æ¤œç´¢ |

## ğŸ¯ å¤‰æ›´ã®ç›®çš„

1. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºä¿**
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ã«æº–æ‹ 
   - ãƒ‡ãƒ¼ã‚¿ã®ä¸€å…ƒç®¡ç†

2. **å¾Œæ–¹äº’æ›æ€§ã®ç¶­æŒ**
   - æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¯¾å¿œ
   - æ®µéšçš„ãªç§»è¡Œã‚’å¯èƒ½ã«ã™ã‚‹

3. **æ©Ÿèƒ½ã®å®Ÿç¾**
   - é¡§å®¢ç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£…
   - è¤‡æ•°åº—èˆ—å¯¾å¿œ

4. **ä¿å®ˆæ€§ã®å‘ä¸Š**
   - æ˜ç¢ºãªãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ«ãƒ¼ãƒ«
   - ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ãƒ­ã‚°å‡ºåŠ›

## ğŸ”„ ä»Šå¾Œã®æ”¹å–„ç‚¹

1. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**
   - æ—¢å­˜ã®`orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`tenant`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’`tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«çµ±ä¸€
   - ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

2. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯**
   - `orders`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`tenant`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ`tenants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
   - ä¸æ•´åˆãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡ºã¨ä¿®æ­£

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
   - ã‚¯ã‚¨ãƒªã®åŠ¹ç‡åŒ–

---

*ä½œæˆæ—¥æ™‚: 2025å¹´1æœˆ*

