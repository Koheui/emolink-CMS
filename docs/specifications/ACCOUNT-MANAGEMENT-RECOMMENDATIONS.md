# アカウント管理の運用推奨事項

## 問題の概要

現在、JWT認証リンクから来たユーザーがパスワード設定画面でエラーが発生する場合があります。これは、既にFirebase Authにアカウントが存在するが、入力したパスワードが既存のパスワードと一致しない場合に発生します。

## 現在の実装の問題点

1. **パスワード設定画面の混乱**: 既存アカウントがある場合でも「パスワードを設定してください」と表示される
2. **エラーメッセージの不明確さ**: 「このメールアドレスは既に登録されています」というメッセージが、初回登録ユーザーには混乱を招く
3. **複数テナント対応の不透明性**: ユーザーが複数の想い出ページを管理できることが明確でない

## 推奨される運用方法

### オプション1: 既存アカウント検出時にログイン画面へリダイレクト（推奨）

**メリット**:
- ユーザー体験が明確
- 既存アカウントと新規アカウントの区別が明確
- パスワードリセット機能を活用可能

**実装方法**:
1. `/claim`ページでJWT検証後、`fetchSignInMethodsForEmail`で既存アカウントを確認
2. 既存アカウントがある場合：
   - パスワード設定画面を表示せず、ログイン画面（`/auth`）にリダイレクト
   - リダイレクト時に「既にアカウントが存在します。ログインしてください」というメッセージを表示
3. 新規アカウントの場合：
   - パスワード設定画面を表示

**ユーザーフロー**:
```
JWT認証リンク → JWT検証 → 既存アカウント確認
  ├─ 既存アカウントあり → /auth（ログイン画面）にリダイレクト
  └─ 新規アカウント → パスワード設定画面
```

### オプション2: パスワード設定画面で既存アカウントを検出してメッセージを表示

**メリット**:
- 一つの画面で完結
- ユーザーが離脱しにくい

**実装方法**:
1. パスワード設定画面で`fetchSignInMethodsForEmail`を実行
2. 既存アカウントがある場合：
   - 「このメールアドレスは既に登録されています。既存のパスワードを入力してください。」というメッセージを表示
   - フォームのタイトルを「ログイン」に変更
3. 新規アカウントの場合：
   - 「パスワードを設定してください」というメッセージを表示

**ユーザーフロー**:
```
JWT認証リンク → JWT検証 → パスワード設定画面
  ├─ 既存アカウント検出 → 「既存のパスワードを入力」メッセージ表示
  └─ 新規アカウント → 「パスワードを設定」メッセージ表示
```

### オプション3: パスワードリセット機能を提供

**メリット**:
- パスワードを忘れた場合にも対応可能
- セキュリティが向上

**実装方法**:
1. パスワード設定画面に「パスワードを忘れた場合」リンクを追加
2. 既存アカウントがある場合、パスワードリセットメールを送信
3. パスワードリセット後、新しいパスワードでログイン

## 複数想い出ページ管理の明確化

### 現在の実装

- ✅ 一つのメールアドレスで複数の想い出ページを管理可能
- ✅ 異なるLPから購入した想い出ページもすべて一つのアカウントで管理
- ✅ エンドユーザーは自分のすべての想い出ページにアクセス可能（テナント問わず）

### 改善提案

1. **想い出ページ一覧の改善**:
   - テナントやLPごとにグループ化して表示
   - 各想い出ページに「どのLPから作成されたか」を表示

2. **ダッシュボードの改善**:
   - 「あなたの想い出ページ」セクションを追加
   - 複数の想い出ページがある場合、一覧表示

3. **メッセージの明確化**:
   - 「複数のLPから作成したページもすべて表示されます」というメッセージをより目立つ場所に配置
   - 新規想い出ページ作成時に「既存のアカウントで管理できます」というメッセージを表示

## 推奨される実装（オプション1）

### 1. `/claim`ページの修正

```typescript
// 既存アカウントがある場合、ログイン画面にリダイレクト
if (signInMethods.length > 0) {
  // 既存アカウントがある場合、ログイン画面にリダイレクト
  if (typeof window !== 'undefined') {
    sessionStorage.setItem('redirectMessage', '既にアカウントが存在します。ログインしてください。');
    sessionStorage.setItem('redirectEmail', claimRequest.email);
  }
  router.push('/auth');
} else {
  // 新規アカウントの場合、パスワード設定画面を表示
  setShowPasswordSetup(true);
}
```

### 2. `/auth`ページの修正

```typescript
// リダイレクトメッセージを表示
useEffect(() => {
  const message = sessionStorage.getItem('redirectMessage');
  const email = sessionStorage.getItem('redirectEmail');
  if (message && email) {
    setMessage(message);
    setEmail(email);
    sessionStorage.removeItem('redirectMessage');
    sessionStorage.removeItem('redirectEmail');
  }
}, []);
```

### 3. パスワード設定画面の改善

- 既存アカウント検出時に「既存のパスワードを入力してください」というメッセージを表示
- パスワードリセットリンクを追加

## まとめ

**推奨される運用方法**: オプション1（既存アカウント検出時にログイン画面へリダイレクト）

**理由**:
1. ユーザー体験が明確
2. 既存アカウントと新規アカウントの区別が明確
3. パスワードリセット機能を活用可能
4. セキュリティが向上

**追加の改善**:
1. 複数想い出ページ管理の明確化
2. ダッシュボードの改善
3. メッセージの明確化

