# エンドユーザー向け複数想い出ページ管理

## 概要

このCMSシステムでは、**一つのメールアドレス（エンドユーザー）で複数の想い出ページを運用**できます。異なるLPから、または同じLPから複数回購入した場合でも、すべての想い出ページを一つのアカウントで管理できます。

## 技術的な制約と解決策

### Firebase Authenticationの制約

Firebase Authenticationは、**一つのメールアドレスに対して一つのアカウントしか作成できません**。これはFirebaseの仕様です。

### 解決策

1. **Firebase Authentication**: 一つのメールアドレスで一つのアカウント（UID）を作成
2. **Firestore**: 同じUID（`ownerUid`）に対して、複数の想い出ページ（memory）を作成可能
3. **テナント分離**: 各想い出ページは`tenant`フィールドを持ち、テナントごとにデータが分離されるが、エンドユーザーは自分のすべての想い出ページにアクセス可能

## データ構造

### Firestore `memories`コレクション

```typescript
memories/{memoryId}: {
  id: string,
  ownerUid: string,      // エンドユーザーのUID（一つのメールアドレス = 一つのUID）
  tenant: string,        // 購入したLPのテナントID
  title: string,
  status: 'draft' | 'published',
  // ... その他のフィールド
}
```

### Firestore `users`コレクション

```typescript
users/{uid}: {
  uid: string,
  email: string,
  tenant: string,        // 現在のデフォルトテナント
  tenants: [             // 複数テナント対応配列（管理用）
    {
      tenant: string,    // テナントID
      role: 'user',
      createdAt: Date,
      updatedAt: Date
    },
    // ... 他のテナント
  ],
  role: 'user',
  createdAt: Date,
  updatedAt: Date
}
```

## 運用フロー

### 1. 初回登録（新規想い出ページ作成）

1. LPから認証リンク（JWT）でアクセス
2. パスワード設定画面が表示される
3. パスワードを設定
4. Firebase Authenticationでアカウント作成（新規）
5. Firestoreにユーザー情報を保存
6. 新しい想い出ページを作成（`tenant`はJWTから取得したテナントID）

### 2. 既存アカウントで別のLPから購入

1. 別のLPから認証リンク（JWT）でアクセス
2. パスワード設定画面が表示される
3. **既に登録されているパスワードを入力**
4. システムが自動的に：
   - 既存のFirebase Authアカウントにログイン
   - Firestoreのユーザーデータを確認
   - 新しいテナントが`tenants`配列に存在しない場合、追加
   - 存在する場合、`updatedAt`を更新
   - `tenant`フィールドを現在のテナントに更新
5. 新しい想い出ページを作成（異なる`tenant`でも同じ`ownerUid`）

### 3. ログイン

1. `/auth`または`/memories/create`でログイン
2. メールアドレスとパスワードを入力
3. ログイン成功後、**自分のすべての想い出ページ**が表示される（テナント問わず）
4. 既存の想い出ページ一覧から編集したいページを選択可能

## 重要なポイント

### ✅ できること

- 一つのメールアドレスで複数の想い出ページを運用
- 異なるLPから購入した想い出ページもすべて一つのアカウントで管理
- 同じLPから複数回購入した場合も、すべての想い出ページを管理可能
- エンドユーザーは自分のすべての想い出ページにアクセス可能（テナント問わず）

### ⚠️ 注意点

1. **パスワードは共有**: 同じメールアドレスでは、すべての想い出ページで同じパスワードを使用
2. **テナント分離**: 各想い出ページは`tenant`フィールドを持ち、テナントごとにデータが分離される
3. **エンドユーザーの視点**: エンドユーザーは自分のすべての想い出ページを表示・編集可能（テナント問わず）
4. **管理者の視点**: 管理者はテナントごとにデータを管理するため、テナントフィルタリングが適用される

## エラーハンドリング

### 「このメールアドレスは既に登録されています」

このエラーは、以下の場合に表示されます：

1. **既存アカウントがあるが、パスワードが間違っている**
   - 解決策: 既に登録されているアカウントのパスワードを入力してください

2. **新規登録を試みたが、Firebase Authで既にアカウントが存在する**
   - 解決策: 既存のパスワードでログインしてください。システムが自動的に新しいテナントを追加します

## 実装詳細

### パスワード設定フォーム (`password-setup-form.tsx`)

1. `fetchSignInMethodsForEmail`でメールアドレスの登録状況を確認
2. 既存アカウントがある場合：
   - `signInWithEmailAndPassword`でログインを試みる
   - ログイン成功後、Firestoreの`tenants`配列に新しいテナントを追加
3. 新規アカウントの場合：
   - `createUserWithEmailAndPassword`でアカウント作成
   - Firestoreにユーザー情報を保存

### 想い出ページ取得 (`getMemoriesByUser`)

- **エンドユーザー**: `filterByTenant: false`（デフォルト）で、自分のすべての想い出ページを取得（テナント問わず）
- **管理者**: `filterByTenant: true`で、現在のテナントの想い出ページのみを取得

### 想い出ページアクセス (`getMemoryById`)

- **エンドユーザー**: `skipTenantCheck: true`で、自分の想い出ページであればテナント問わずアクセス可能
- **管理者**: `skipTenantCheck: false`（デフォルト）で、テナントチェックが適用される

## 今後の改善案

1. **想い出ページ一覧の改善**: テナントやLPごとにグループ化して表示
2. **検索・フィルタ機能**: テナントやLPでフィルタリング可能にする
3. **一括操作**: 複数の想い出ページを一括で公開/非公開にする機能

