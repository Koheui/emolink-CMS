# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢è¨ˆç”»

## ğŸ“‹ æ¦‚è¦

åº—èˆ—æƒ…å ±ã€ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ˜ç¢ºã«åˆ†é›¢ã™ã‚‹ãŸã‚ã®è¨­è¨ˆã¨å®Ÿè£…è¨ˆç”»ã§ã™ã€‚

## ğŸ—‚ï¸ æ–°ã—ã„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ 

### 1. `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼/é¡§å®¢ã®ã¿ï¼‰

**ç”¨é€”**: æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ã‚’ä½œæˆãƒ»ç®¡ç†ã™ã‚‹é¡§å®¢ï¼ˆã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®åŸºæœ¬æƒ…å ±

**ãƒ‘ã‚¹**: `users/{uid}`

**ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
```typescript
{
  uid: string;                    // Firebase Auth UIDï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼‰
  email: string;                  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  displayName?: string;            // è¡¨ç¤ºå
  tenant: string;                 // ãƒ†ãƒŠãƒ³ãƒˆåï¼ˆé¡§å®¢ãŒæ‰€å±ã™ã‚‹åº—èˆ—ï¼‰
  tenants?: string[];             // è¤‡æ•°ãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œï¼ˆé…åˆ—ï¼‰
  createdAt: Date;                // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥æ™‚
  updatedAt: Date;                // æœ€çµ‚æ›´æ–°æ—¥æ™‚
}
```

**æ³¨æ„**: `role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤ï¼ˆã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã®ãŸã‚ä¸è¦ï¼‰

---

### 2. `tenants` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåº—èˆ—æƒ…å ±ï¼‰

**ç”¨é€”**: åº—èˆ—ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰ã®åŸºæœ¬æƒ…å ±ã¨è¨­å®š

**ãƒ‘ã‚¹**: `tenants/{tenantId}`

**ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
```typescript
{
  id: string;                     // ãƒ†ãƒŠãƒ³ãƒˆIDï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼‰
  name: string;                   // åº—èˆ—å
  description?: string;            // èª¬æ˜
  allowedLpIds: string[];         // è¨±å¯ã•ã‚ŒãŸLP ID
  enabledProductTypes: string[];  // æœ‰åŠ¹ãªå•†å“ã‚¿ã‚¤ãƒ—
  settings: {
    maxClaimRequestsPerHour: number;
    emailTemplate: string;
    branding: {
      logo?: string;
      colors: string[];
      theme: string;
    };
    fulfillmentMode: 'tenantDirect' | 'vendorDirect';
  };
  status: 'active' | 'inactive' | 'suspended';
  createdAt: Date;
  updatedAt: Date;
}
```

**æ³¨æ„**: æ—¢å­˜ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãã®ã¾ã¾ä½¿ç”¨

---

### 3. `staff` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•/ç®¡ç†è€…ï¼‰

**ç”¨é€”**: åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆç®¡ç†è€…ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ã®åŸºæœ¬æƒ…å ±

**ãƒ‘ã‚¹**: `staff/{uid}`

**ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
```typescript
{
  uid: string;                    // Firebase Auth UIDï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼‰
  email: string;                  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  displayName?: string;            // è¡¨ç¤ºå
  role: 'tenantAdmin' | 'superAdmin' | 'fulfillmentOperator';
  adminTenant: string;            // ç®¡ç†ã™ã‚‹ãƒ†ãƒŠãƒ³ãƒˆID
  permissions?: {
    canManageUsers: boolean;      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ¨©é™
    canManageOrders: boolean;     // æ³¨æ–‡ç®¡ç†æ¨©é™
    canManageTenants: boolean;     // ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†æ¨©é™ï¼ˆsuperAdminã®ã¿ï¼‰
    canWriteNfc: boolean;          // NFCæ›¸ãè¾¼ã¿æ¨©é™
  };
  createdAt: Date;                // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥æ™‚
  updatedAt: Date;                // æœ€çµ‚æ›´æ–°æ—¥æ™‚
}
```

---

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

### Phase 1: æ–°ã—ã„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ ã®å®Ÿè£…

1. **å‹å®šç¾©ã®æ›´æ–°**
   - `User`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰`role`ã¨`adminTenant`ã‚’å‰Šé™¤
   - `Staff`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ–°è¦ä½œæˆ

2. **Firestoreé–¢æ•°ã®è¿½åŠ **
   - `createStaff` - ã‚¹ã‚¿ãƒƒãƒ•ä½œæˆ
   - `getStaffByUid` - ã‚¹ã‚¿ãƒƒãƒ•å–å¾—
   - `getStaffByTenant` - ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚¹ã‚¿ãƒƒãƒ•å–å¾—
   - `updateStaff` - ã‚¹ã‚¿ãƒƒãƒ•æ›´æ–°
   - `deleteStaff` - ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤

3. **èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°**
   - `SecretKeyAuthContext`ã§`staff`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç®¡ç†è€…æƒ…å ±ã‚’å–å¾—
   - `AuthContext`ã‚‚åŒæ§˜ã«æ›´æ–°

### Phase 2: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

1. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ**
   - `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰`role`ãŒç®¡ç†è€…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
   - è©²å½“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’`staff`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼
   - `users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰`role`ã¨`adminTenant`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤

2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**
   - Firebase Functionsã¾ãŸã¯ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè¡Œ
   - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºèª

### Phase 3: æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°

1. **èªè¨¼é–¢é€£**
   - `src/contexts/auth-context.tsx`
   - `src/contexts/secret-key-auth-context.tsx`

2. **ç®¡ç†ç”»é¢**
   - `src/app/admin/users/page.tsx` - ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
   - `src/app/admin/staff/page.tsx` - ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ç”»é¢ï¼ˆæ–°è¦ä½œæˆï¼‰

3. **Firestoreé–¢æ•°**
   - `src/lib/firestore.ts` - ã‚¹ã‚¿ãƒƒãƒ•é–¢é€£é–¢æ•°ã®è¿½åŠ 

4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«**
   - `firestore.rules` - `staff`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ«ãƒ¼ãƒ«è¿½åŠ 

---

## ğŸ“ å®Ÿè£…ã®å„ªå…ˆé †ä½

1. **é«˜å„ªå…ˆåº¦**: å‹å®šç¾©ã¨Firestoreé–¢æ•°ã®å®Ÿè£…
2. **ä¸­å„ªå…ˆåº¦**: èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°
3. **ä½å„ªå…ˆåº¦**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ

---

## âš ï¸ æ³¨æ„äº‹é …

1. **å¾Œæ–¹äº’æ›æ€§**: ç§»è¡ŒæœŸé–“ä¸­ã¯æ—¢å­˜ã®`users`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ç¢ºèª
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’é©åˆ‡ã«å®Ÿè£…
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¯ã‚¨ãƒªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é©åˆ‡ã«è¨­å®š

