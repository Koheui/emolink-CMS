# アカウント作成フロー - CRM管理用

## 📋 概要

このドキュメントは、アカウント作成から公開ページURL確定までの完全なフローを記録したものです。のちにCRMで管理する際の参考資料として使用してください。

## 🔄 完全フロー

### ステップ1: LPフォーム送信
**担当**: LP側（自動）
**タイミング**: ユーザーがLPフォームを送信した時点

**処理内容**:
1. LP側でJWTトークンを生成（72時間有効）
2. LP側で秘密鍵を生成（16桁の英数字）
3. 認証リンクを生成: `https://emolink-cms.web.app/claim?k={JWTトークン}`
4. CMS API (`/api/lp-form`) に以下を送信:
   ```json
   {
     "email": "user@example.com",
     "tenant": "petmem",
     "lpId": "direct",
     "productType": "acrylic",
     "recaptchaToken": "03AGdBq27...",
     "link": "https://emolink-cms.web.app/claim?k={JWTトークン}",
     "secretKey": "abc123def456ghi789"
   }
   ```

**CMS側の処理**:
- `claimRequest`を作成（`status: 'pending'`）
- `order`を作成
- `requestId`を返す

**確認ポイント**:
- [ ] `requestId`が正常に返されたか
- [ ] `claimRequest`がFirestoreに保存されたか
- [ ] `order`がFirestoreに保存されたか

---

### ステップ2: 認証リンク送信
**担当**: LP側（自動）
**タイミング**: ステップ1の直後

**処理内容**:
1. 認証リンクを含むメールをユーザーに送信
2. メール内容:
   - 認証リンク（`link`）
   - 説明文

**確認ポイント**:
- [ ] メールが正常に送信されたか
- [ ] 認証リンクが正しく生成されているか

---

### ステップ3: ユーザー認証
**担当**: ユーザー（手動）
**タイミング**: ユーザーが認証リンクをクリックした時点

**処理内容**:
1. ユーザーが認証リンクをクリック
2. CMS側でJWTトークンを検証（Firebase Functions API経由）
3. パスワード設定画面を表示
4. ユーザーがパスワードを設定（新規）またはログイン（既存アカウント）

**CMS側の処理（自動）**:
- 認証成功時に以下を自動実行:
  1. 空の公開ページを作成（`publicPageId`を確定）
  2. `publicPageUrl`を生成: `https://emolink-cms.web.app/public/{publicPageId}?tenant={tenant}`
  3. `loginUrl`を生成: `https://emolink-cms.web.app/memories/create`
  4. `claimRequest`を更新:
     - `publicPageId`: 公開ページID
     - `publicPageUrl`: 公開ページURL
     - `loginUrl`: ログインURL
     - `status`: `'claimed'`
     - `claimedByUid`: ユーザーUID
     - `claimedAt`: 現在時刻

**確認ポイント**:
- [ ] 認証が正常に完了したか
- [ ] `publicPageId`が生成されたか
- [ ] `claimRequest`が更新されたか（`status: 'claimed'`）

---

### ステップ4: URL取得（ポーリング）
**担当**: LP側（自動）
**タイミング**: ステップ2の後、定期的にポーリング

**処理内容**:
1. 以下のAPIを定期的に呼び出し（5秒間隔、最大30回）:
   ```
   GET https://asia-northeast1-memorylink-cms.cloudfunctions.net/apiV2/api/claim/{requestId}/urls
   ```
   **注意**: このAPIはFirebase Functionsとして実装する必要があります。
2. レスポンスを確認:
   - `ok: true` → URL取得成功、ステップ5へ
   - `status: 202` → URL未生成、ポーリング継続
   - その他のエラー → エラーハンドリング

**確認ポイント**:
- [ ] APIが正常に呼び出せているか
- [ ] レスポンスが正しいか
- [ ] タイムアウトが発生していないか

---

### ステップ5: メール送信（URL通知）
**担当**: LP側（自動）
**タイミング**: ステップ4でURL取得成功時

**処理内容**:
1. 取得したURLを使用してメールを送信
2. メール内容:
   - 公開ページURL（NFCタグ用）
   - ログインURL（次回ログイン用）
   - 説明文

**確認ポイント**:
- [ ] メールが正常に送信されたか
- [ ] URLが正しく記載されているか
- [ ] メール内容が正しいか

---

### ステップ6: NFCタグ入力（手作業）
**担当**: 作業者（手動）
**タイミング**: ステップ5の後、物理的な作業

**処理内容**:
1. メールに記載された公開ページURLを確認
2. NFCタグにURLを入力
3. 入力完了を確認

**確認ポイント**:
- [ ] URLが正しく入力されたか
- [ ] NFCタグが正常に動作するか
- [ ] 入力ミスがないか

**⚠️ ミス防止のためのチェックリスト**:
- [ ] URLのコピー&ペーストを使用（手入力禁止）
- [ ] URLの最後に余分なスペースや改行がないか確認
- [ ] テナント情報（`?tenant=...`）が含まれているか確認
- [ ] 入力後にNFCタグを読み取って確認

---

### ステップ7: 想い出ページ作成
**担当**: ユーザー（手動）
**タイミング**: ユーザーがログインURLにアクセスした時点

**処理内容**:
1. ユーザーがログインURLにアクセス
2. メールアドレスとパスワードでログイン
3. 想い出ページを作成・編集
4. 保存時に、既に作成済みの公開ページ（`publicPageId`）に内容を反映

**確認ポイント**:
- [ ] ユーザーが正常にログインできているか
- [ ] 想い出ページが正常に作成されているか
- [ ] 公開ページに内容が反映されているか

---

## 🔍 エラーハンドリング

### エラーケース1: URLが取得できない（タイムアウト）
**原因**: ユーザーが認証リンクをクリックしていない、または認証が完了していない

**対応**:
1. ユーザーに認証リンクを再送信
2. 手動で確認（CRMでステータスを確認）
3. 必要に応じて、ユーザーに直接連絡

### エラーケース2: NFCタグ入力ミス
**原因**: URLの手入力ミス、コピー&ペーストミス

**対応**:
1. NFCタグを再入力
2. 入力前にURLを再確認
3. 入力後に必ず読み取って確認

### エラーケース3: 公開ページが表示されない
**原因**: `publicPageId`と`memoryId`の紐付けが正しくない

**対応**:
1. Firestoreで`claimRequest`を確認
2. `publicPageId`と`memoryId`の紐付けを確認
3. 必要に応じて手動で修正

---

## 📊 CRM管理項目

### 必須項目
- `requestId`: リクエストID
- `email`: ユーザーメールアドレス
- `tenant`: テナント名
- `status`: ステータス（`pending` | `sent` | `claimed` | `expired`）
- `publicPageId`: 公開ページID
- `publicPageUrl`: 公開ページURL
- `loginUrl`: ログインURL
- `claimedAt`: 認証完了日時
- `nfcWritten`: NFCタグ入力完了フラグ
- `nfcWrittenAt`: NFCタグ入力完了日時

### 推奨項目
- `lpId`: LP ID
- `productType`: 商品タイプ
- `orderId`: 注文ID
- `memoryId`: 想い出ページID（作成後）

---

## 🔐 セキュリティ考慮事項

1. **テナント検証**: すべてのAPIリクエストでテナント検証が自動的に行われます
2. **JWTトークン**: 72時間有効、期限切れ後は再発行が必要
3. **秘密鍵**: 注文管理用、認証には使用しない
4. **URL**: 公開ページURLは機密情報ではありませんが、適切に管理してください

---

## 📝 チェックリスト（作業者用）

### アカウント作成時
- [ ] LPフォーム送信が完了したか
- [ ] 認証リンクメールが送信されたか
- [ ] ユーザーが認証を完了したか（CRMで確認）
- [ ] 公開ページURLが生成されたか（CRMで確認）

### NFCタグ入力時
- [ ] メールから公開ページURLを取得
- [ ] URLをコピー&ペースト（手入力禁止）
- [ ] URLの最後に余分なスペースや改行がないか確認
- [ ] NFCタグにURLを入力
- [ ] 入力後にNFCタグを読み取って確認
- [ ] 読み取り結果が正しいか確認
- [ ] CRMで`nfcWritten`フラグを更新

### 想い出ページ作成時
- [ ] ユーザーがログインURLにアクセスしたか
- [ ] 想い出ページが作成されたか
- [ ] 公開ページに内容が反映されているか
- [ ] CRMで`memoryId`を更新

---

## 🔄 フロー図

```
[ユーザー] → [LPフォーム送信] → [LP側: 認証リンク送信]
                                           ↓
[ユーザー: 認証リンククリック] → [CMS: 認証処理]
                                           ↓
[CMS: 公開ページ作成 & URL生成] → [LP側: URL取得（ポーリング）]
                                           ↓
[LP側: メール送信（URL通知）] → [作業者: NFCタグ入力]
                                           ↓
[ユーザー: ログイン & 想い出ページ作成] → [完了]
```

---

## 📞 連絡先

問題が発生した場合は、以下に連絡してください：
- CMS開発チーム
- LP開発チーム
- 運営チーム

---

**最終更新日**: 2025-01-XX
**バージョン**: 1.0

