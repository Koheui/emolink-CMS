# CMS実装と仕様書の相違点まとめ

**作成日**: 2025-11-27  
**仕様書**: `LP-API-integration.md`  
**実装状況**: 店舗エントリーフォーム（`customer-form.js`）の実装

---

## 📋 概要

このドキュメントは、`LP-API-integration.md`の仕様書と現在のCMS実装の相違点をまとめたものです。実装を進める際の参考としてください。

---

## 🔍 主な相違点

### 1. 認証リンクのURL形式

#### 仕様書
```
https://emolink.net/claim?k={JWTトークン}
```

#### 現在の実装
```
https://emolink-cms.web.app/claim?k={JWTトークン}
```

**影響**: CMSのドメインが異なるため、CMS側でリンクを処理する際に注意が必要です。

**対応**: CMS側の`/claim`エンドポイントが正しいドメインで動作することを確認してください。

---

### 2. reCAPTCHAトークンの検証

#### 仕様書
- reCAPTCHA v3トークンが必須
- スコアが0.5未満の場合は拒否
- 開発環境では`dev-token`を許可

#### 現在の実装
- フロントエンド（`customer-form.js`）では`'dev-token'`をハードコード
- CMS側（`lpFormV2.ts`）では`recaptchaToken`を受け取るが、検証処理が未実装

**影響**: 本番環境では実際のreCAPTCHAトークンが必要です。

**対応**:
1. フロントエンドで実際のreCAPTCHAトークンを取得する実装を追加
2. CMS側でreCAPTCHA検証処理を実装

---

### 3. Origin検証

#### 仕様書
- 本番環境では`Origin`ヘッダーまたは`Referer`ヘッダーからテナント情報を検証
- 許可されるOriginはテナントごとに設定されたLPドメイン
- 開発環境では任意のOriginを許可

#### 現在の実装
- Origin検証が未実装

**影響**: セキュリティ上のリスクがあります。

**対応**: CMS側でOrigin検証を実装する必要があります。

---

### 4. レスポンス形式

#### 仕様書
```json
{
  "ok": true,
  "message": "Claim request received and saved",
  "requestId": "req_abc123def456",
  "link": "https://emolink.net/claim?k=..."
}
```

#### 現在の実装
- CMS側（`lpFormV2.ts`）: 仕様書に準拠（`ok`フィールドを使用）
- フロントエンド（`customer-form.js`）: `success`フィールドも使用

**影響**: フロントエンドでレスポンスを処理する際に、`ok`と`success`の両方をチェックする必要があります。

**対応**: フロントエンドのレスポンス処理を統一するか、CMS側のレスポンス形式を確認してください。

---

### 5. メール送信のタイミングと方法

#### 仕様書
- **LP側でメール送信を行う**
- CMS側ではメール送信を行わない

#### 現在の実装
- フロントエンドから`/api/admin/send-email`エンドポイントを呼び出してメール送信
- 実質的にはCMS側（Firebase Functions）でメール送信を実行

**影響**: 仕様書とは異なる実装ですが、技術的には問題ありません。

**対応**: 
- この実装方法を維持する場合は、仕様書を更新するか、この実装方法を明記してください
- 完全にLP側でメール送信を行う場合は、フロントエンドから直接メールサービス（SendGrid、Mailgun等）を呼び出す実装が必要です

---

### 6. JWT_SECRETの管理

#### 仕様書
- JWT_SECRETはLP側で管理（仕様書には明記されていないが、JWTトークンを生成するためには必要）

#### 現在の実装
- フロントエンド（`customer-form.js`）で`getJWTSecret()`関数を呼び出し
- 現在はデフォルト値（`'emolinkemolinkemo'`）を使用
- APIエンドポイントから取得する実装は未完成

**影響**: セキュリティ上のリスクがあります。JWT_SECRETをフロントエンドにハードコードするのは避けるべきです。

**対応**:
1. JWT_SECRETを取得するAPIエンドポイントを作成
2. または、JWTトークン生成をCMS側のAPIエンドポイントで行う（推奨）

---

### 7. エラーレスポンス形式

#### 仕様書
```json
{
  "error": "Missing required fields"
}
```

#### 現在の実装
```json
{
  "ok": false,
  "error": "Missing required fields"
}
```

**影響**: フロントエンドでエラーハンドリングする際に、`ok`フィールドの有無を確認する必要があります。

**対応**: エラーレスポンスも`ok: false`を含める形式に統一されていますが、仕様書との整合性を確認してください。

---

### 8. データ保存先

#### 仕様書
- `claimRequests`への保存
- `orders`への保存
- データの検証と監査ログの記録

#### 現在の実装
- `claimRequests`への保存 ✅
- `orders`への保存 ✅
- `secretKeys`への保存 ✅（仕様書には明記されていないが、実装されている）
- 監査ログの記録 ❌（未実装）

**影響**: 監査ログが記録されないため、トラブルシューティングが困難になる可能性があります。

**対応**: 監査ログの記録機能を追加することを推奨します。

---

## 🔧 実装上の注意点

### 1. JWTトークンの検証

現在の実装では、CMS側でJWTトークンを検証していますが、JWT_SECRETがフロントエンドとCMS側で一致している必要があります。

**推奨**: JWT_SECRETを環境変数で管理し、CMS側とフロントエンド（API経由）で共有する。

### 2. メール送信の実装

現在の実装では、フロントエンドからCMS側のAPIを呼び出してメール送信を行っています。これは仕様書とは異なりますが、技術的には問題ありません。

**推奨**: 
- この実装方法を維持する場合は、仕様書を更新する
- または、完全にLP側でメール送信を行う場合は、メールサービス（SendGrid、Mailgun等）を直接呼び出す実装が必要

### 3. セキュリティ対策

- Origin検証の実装が必要
- reCAPTCHA検証の実装が必要
- JWT_SECRETの適切な管理が必要

---

## 📝 今後の対応が必要な項目

### 高優先度
1. ✅ JWTトークン生成機能（実装済み）
2. ✅ 秘密鍵生成機能（実装済み）
3. ✅ 認証リンク生成機能（実装済み）
4. ⚠️ reCAPTCHA検証の実装（CMS側で未実装）
5. ⚠️ Origin検証の実装（未実装）
6. ⚠️ JWT_SECRETの適切な管理（現在はデフォルト値を使用）

### 中優先度
1. 監査ログの記録機能
2. レスポンス形式の統一
3. エラーハンドリングの改善

### 低優先度
1. 仕様書の更新（実装方法の明記）
2. テストの追加

---

## 🎯 まとめ

現在の実装は、仕様書の主要な要件（JWTトークン生成、秘密鍵生成、認証リンク生成、メール送信）を満たしていますが、以下の点で改善が必要です：

1. **セキュリティ**: Origin検証、reCAPTCHA検証の実装
2. **JWT_SECRET管理**: 適切な管理方法の実装
3. **監査ログ**: トラブルシューティングのためのログ記録

これらの改善を進めることで、仕様書により準拠した実装になります。

