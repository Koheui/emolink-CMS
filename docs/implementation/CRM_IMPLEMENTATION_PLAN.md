# CRMæ§‹ç¯‰å®Ÿè£…è¨ˆç”»

## ğŸ“‹ æ¦‚è¦

ç¤¾å†…ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘ã®CRMï¼ˆé¡§å®¢é–¢ä¿‚ç®¡ç†ï¼‰ã‚·ã‚¹ãƒ†ãƒ ã¨NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

## ğŸ¯ å®Ÿè£…ç›®æ¨™

1. **é¡§å®¢ç®¡ç†æ©Ÿèƒ½**: é¡§å®¢æƒ…å ±ã®ä¸€è¦§è¡¨ç¤ºãƒ»æ¤œç´¢ãƒ»è©³ç´°è¡¨ç¤º
2. **æ³¨æ–‡ç®¡ç†æ©Ÿèƒ½**: æ³¨æ–‡ã®ä¸€è¦§è¡¨ç¤ºãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ãƒ»é€²æ—ç¢ºèª
3. **NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½**: å…¬é–‹ãƒšãƒ¼ã‚¸URLã‚’NFCã‚¿ã‚°ã«æ›¸ãè¾¼ã‚€

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
src/app/admin/crm/
â”œâ”€â”€ customers/
â”‚   â”œâ”€â”€ page.tsx              # é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ [customerId]/
â”‚       â””â”€â”€ page.tsx          # é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆNFCæ›¸ãè¾¼ã¿å«ã‚€ï¼‰
â”œâ”€â”€ orders/
â”‚   â”œâ”€â”€ page.tsx              # æ³¨æ–‡ä¸€è¦§ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ [orderId]/
â”‚       â””â”€â”€ page.tsx          # æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸
â””â”€â”€ nfc-writer/
    â””â”€â”€ page.tsx              # NFCæ›¸ãè¾¼ã¿å°‚ç”¨ãƒšãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```

## ğŸ” æ¨©é™ç®¡ç†

### ãƒ­ãƒ¼ãƒ«å®šç¾©

- **`fulfillmentOperator`**: åˆ¶ä½œãƒ»é…é€æ‹…å½“è€…
  - é¡§å®¢æƒ…å ±ã®é–²è¦§
  - æ³¨æ–‡æƒ…å ±ã®é–²è¦§ãƒ»æ›´æ–°
  - NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½ã®ä½¿ç”¨
  - é…é€æƒ…å ±ã®æ›´æ–°

- **`tenantAdmin`**: ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…
  - ä¸Šè¨˜ã™ã¹ã¦ + ãƒ†ãƒŠãƒ³ãƒˆè¨­å®šã®ç®¡ç†

- **`superAdmin`**: ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…
  - ã™ã¹ã¦ã®æ¨©é™

### æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°

```typescript
// src/lib/security/role-check.ts
export function canAccessCRM(user: User): boolean {
  return user.role === 'fulfillmentOperator' || 
         user.role === 'tenantAdmin' || 
         user.role === 'superAdmin';
}

export function canWriteNFC(user: User): boolean {
  return canAccessCRM(user);
}
```

## ğŸ“Š å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: æ¨©é™ç®¡ç†ã®å¼·åŒ–ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

1. **æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®å®Ÿè£…**
   - `src/lib/security/role-check.ts` ã‚’ä½œæˆ
   - `canAccessCRM()`, `canWriteNFC()` é–¢æ•°ã‚’å®Ÿè£…

2. **èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ‹¡å¼µ**
   - `useAuth` ã¾ãŸã¯ `useSecretKeyAuth` ã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
   - CRMã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç¢ºèª

3. **Firestore Rulesã®æ›´æ–°**
   - `fulfillmentOperator` ãƒ­ãƒ¼ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¿½åŠ 

### Phase 2: é¡§å®¢ç®¡ç†æ©Ÿèƒ½ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

1. **é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸** (`/admin/crm/customers`)
   - é¡§å®¢ä¸€è¦§ã®è¡¨ç¤ºï¼ˆ`users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - æ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€è¡¨ç¤ºåï¼‰
   - ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ï¼ˆãƒ†ãƒŠãƒ³ãƒˆã€ä½œæˆæ—¥ï¼‰
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

2. **é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸** (`/admin/crm/customers/[customerId]`)
   - é¡§å®¢åŸºæœ¬æƒ…å ±ã®è¡¨ç¤º
   - æ³¨æ–‡å±¥æ­´ã®è¡¨ç¤ºï¼ˆ`orders` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ä¸€è¦§ï¼ˆ`memories` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ï¼ˆ`claimRequests` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - **NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³**ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸URLãŒã‚ã‚‹å ´åˆï¼‰

### Phase 3: æ³¨æ–‡ç®¡ç†æ©Ÿèƒ½ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

1. **æ³¨æ–‡ä¸€è¦§ãƒšãƒ¼ã‚¸** (`/admin/crm/orders`)
   - æ³¨æ–‡ä¸€è¦§ã®è¡¨ç¤ºï¼ˆ`orders` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ±ºæ¸ˆå®Œäº†ã€åˆ¶ä½œä¸­ã€é…é€å¾…ã¡ã€é…é€æ¸ˆã¿ï¼‰
   - æ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€æ³¨æ–‡IDï¼‰
   - ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆä½œæˆæ—¥ã€æ±ºæ¸ˆæ—¥ï¼‰

2. **æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸** (`/admin/crm/orders/[orderId]`)
   - æ³¨æ–‡æƒ…å ±ã®è¡¨ç¤º
   - æ±ºæ¸ˆæƒ…å ±ã®ç¢ºèª
   - åˆ¶ä½œé€²æ—ã®ç¢ºèªï¼ˆ`acrylicPhotos` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - é…é€æƒ…å ±ã®è¡¨ç¤ºãƒ»æ›´æ–°ï¼ˆ`shippingInfo` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ©Ÿèƒ½

### Phase 4: NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

1. **Web NFC APIã®çµ±åˆ**
   - `src/lib/nfc/writer.ts` ã‚’ä½œæˆ
   - NFCæ›¸ãè¾¼ã¿é–¢æ•°ã®å®Ÿè£…
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

2. **NFCæ›¸ãè¾¼ã¿UI**
   - é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã«æ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
   - æ›¸ãè¾¼ã¿ä¸­ã®çŠ¶æ…‹è¡¨ç¤º
   - æˆåŠŸãƒ»å¤±æ•—ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹

3. **æ›¸ãè¾¼ã¿å±¥æ­´ã®è¨˜éŒ²**
   - `orders.nfc.written` ã‚’æ›´æ–°
   - `orders.nfc.writtenAt` ã‚’è¨˜éŒ²
   - `orders.nfc.operator` ã‚’è¨˜éŒ²ï¼ˆæ“ä½œè€…UIDï¼‰

## ğŸ”§ æŠ€è¡“å®Ÿè£…è©³ç´°

### 1. é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸

```typescript
// src/app/admin/crm/customers/page.tsx
- é¡§å®¢ä¸€è¦§ã®å–å¾—ï¼ˆusers ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
- é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
```

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®é¡§å®¢ä¸€è¦§è¡¨ç¤º
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»è¡¨ç¤ºåã§ã®æ¤œç´¢
- ä½œæˆæ—¥ã§ã®ã‚½ãƒ¼ãƒˆ
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ50ä»¶/ãƒšãƒ¼ã‚¸ï¼‰

### 2. é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸

```typescript
// src/app/admin/crm/customers/[customerId]/page.tsx
- é¡§å®¢åŸºæœ¬æƒ…å ±ã®è¡¨ç¤º
- æ³¨æ–‡å±¥æ­´ã®è¡¨ç¤º
- æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ä¸€è¦§ã®è¡¨ç¤º
- NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³
```

**ä¸»è¦æ©Ÿèƒ½**:
- é¡§å®¢æƒ…å ±ã®è¡¨ç¤ºï¼ˆ`users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
- æ³¨æ–‡å±¥æ­´ã®è¡¨ç¤ºï¼ˆ`orders` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€`email`ã§ç´ä»˜ã‘ï¼‰
- æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ä¸€è¦§ï¼ˆ`memories` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€`ownerUid`ã§ç´ä»˜ã‘ï¼‰
- å…¬é–‹ãƒšãƒ¼ã‚¸URLã®è¡¨ç¤º
- **NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³**ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸URLãŒã‚ã‚‹å ´åˆï¼‰

### 3. NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½

```typescript
// src/lib/nfc/writer.ts
export async function writeNFCUrl(url: string): Promise<void> {
  if (!('NDEFWriter' in window)) {
    throw new Error('NFC API is not supported in this browser');
  }
  
  const writer = new NDEFWriter();
  await writer.write({
    records: [{
      recordType: 'url',
      data: url
    }]
  });
}
```

**å®Ÿè£…è¦ä»¶**:
- Chrome 89+ ã§å‹•ä½œï¼ˆWeb NFC APIï¼‰
- HTTPSç’°å¢ƒãŒå¿…è¦
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨±å¯ãŒå¿…è¦
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆNFCæœªå¯¾å¿œã€æ›¸ãè¾¼ã¿å¤±æ•—ãªã©ï¼‰

**UIè¦ä»¶**:
- æ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸URLãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
- æ›¸ãè¾¼ã¿ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
- æˆåŠŸæ™‚ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼ˆã€Œæ›¸ãè¾¼ã¿ãŒæˆåŠŸã—ã¾ã—ãŸï¼ã€ï¼‰
- å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### 4. æ³¨æ–‡ç®¡ç†æ©Ÿèƒ½

```typescript
// src/app/admin/crm/orders/page.tsx
- æ³¨æ–‡ä¸€è¦§ã®å–å¾—ï¼ˆorders ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
- æ¤œç´¢æ©Ÿèƒ½
```

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®æ³¨æ–‡ä¸€è¦§è¡¨ç¤º
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ±ºæ¸ˆå®Œäº†ã€åˆ¶ä½œä¸­ã€é…é€å¾…ã¡ã€é…é€æ¸ˆã¿ï¼‰
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»æ³¨æ–‡IDã§ã®æ¤œç´¢
- ä½œæˆæ—¥ãƒ»æ±ºæ¸ˆæ—¥ã§ã®ã‚½ãƒ¼ãƒˆ

## ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã§ã®NFCæ›¸ãè¾¼ã¿ãƒ•ãƒ­ãƒ¼

1. é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. é¡§å®¢ã®æ³¨æ–‡å±¥æ­´ã‹ã‚‰å…¬é–‹ãƒšãƒ¼ã‚¸URLã‚’å–å¾—
3. ã€ŒNFCæ›¸ãè¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ–ãƒ©ã‚¦ã‚¶ãŒNFCæ›¸ãè¾¼ã¿è¨±å¯ã‚’è¦æ±‚
5. NFCã‚¿ã‚°ã‚’ãƒ‡ãƒã‚¤ã‚¹ã«è¿‘ã¥ã‘ã‚‹
6. æ›¸ãè¾¼ã¿å®Ÿè¡Œ
7. æˆåŠŸæ™‚: `orders.nfc.written = true` ã‚’æ›´æ–°
8. æˆåŠŸã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’è¡¨ç¤º

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **æ¨©é™ãƒã‚§ãƒƒã‚¯**: ã™ã¹ã¦ã®CRMãƒšãƒ¼ã‚¸ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½
2. **ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢
3. **ç›£æŸ»ãƒ­ã‚°**: NFCæ›¸ãè¾¼ã¿æ“ä½œã‚’è¨˜éŒ²
4. **ãƒ‡ãƒ¼ã‚¿ä¿è­·**: é¡§å®¢æƒ…å ±ã®é©åˆ‡ãªä¿è­·

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ¨å¥¨ï¼‰

1. **Week 1**: Phase 1ï¼ˆæ¨©é™ç®¡ç†ã®å¼·åŒ–ï¼‰
2. **Week 2**: Phase 2ï¼ˆé¡§å®¢ç®¡ç†æ©Ÿèƒ½ï¼‰
3. **Week 3**: Phase 3ï¼ˆæ³¨æ–‡ç®¡ç†æ©Ÿèƒ½ï¼‰
4. **Week 4**: Phase 4ï¼ˆNFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½ï¼‰

## ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®

1. **æ¨©é™ãƒ†ã‚¹ãƒˆ**: å„ãƒ­ãƒ¼ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª
2. **ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ**: é¡§å®¢ãƒ»æ³¨æ–‡æƒ…å ±ã®æ­£ç¢ºãªè¡¨ç¤º
3. **NFCæ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ**: å®Ÿéš›ã®NFCã‚¿ã‚°ã§ã®æ›¸ãè¾¼ã¿ç¢ºèª
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ**: å„ç¨®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ç¢ºèª

## ğŸ¨ UI/UXè¨­è¨ˆè©³ç´°

### 1. é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸ã®UI

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**:
- æ¤œç´¢ãƒãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰
- ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ï¼ˆãƒ†ãƒŠãƒ³ãƒˆã€ä½œæˆæ—¥ï¼‰
- é¡§å®¢ã‚«ãƒ¼ãƒ‰ä¸€è¦§ï¼ˆã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºï¼‰
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰

**é¡§å®¢ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºé …ç›®**:
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- è¡¨ç¤ºåï¼ˆã‚ã‚Œã°ï¼‰
- ãƒ†ãƒŠãƒ³ãƒˆå
- ä½œæˆæ—¥
- æ³¨æ–‡æ•°ï¼ˆãƒãƒƒã‚¸è¡¨ç¤ºï¼‰
- è©³ç´°ãƒœã‚¿ãƒ³

### 2. é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã®UI

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**:
- é¡§å®¢åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰
- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³:
  - æ³¨æ–‡å±¥æ­´
  - æƒ³ã„å‡ºãƒšãƒ¼ã‚¸
  - è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´
- NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸URLãŒã‚ã‚‹å ´åˆã€ç›®ç«‹ã¤ä½ç½®ã«é…ç½®ï¼‰

**é¡§å®¢åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå¤§ããè¡¨ç¤ºï¼‰
- è¡¨ç¤ºå
- ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥
- æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥ï¼ˆã‚ã‚Œã°ï¼‰

**NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³**:
- å…¬é–‹ãƒšãƒ¼ã‚¸URLãŒã‚ã‚‹æ³¨æ–‡ã«å¯¾ã—ã¦è¡¨ç¤º
- ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ–ãƒ©ã‚¦ã‚¶è¨±å¯ â†’ NFCã‚¿ã‚°ã‚’è¿‘ã¥ã‘ã‚‹ â†’ æ›¸ãè¾¼ã¿å®Ÿè¡Œ
- æˆåŠŸæ™‚: å¤§ããªæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

### 3. æ³¨æ–‡ä¸€è¦§ãƒšãƒ¼ã‚¸ã®UI

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**:
- æ¤œç´¢ãƒãƒ¼ + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä¸Šéƒ¨ï¼‰
- æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸€è¦§è¡¨ç¤ºï¼‰
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰

**æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—**:
- æ³¨æ–‡ID
- é¡§å®¢ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- å•†å“å
- æ±ºæ¸ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- ä½œæˆæ—¥
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè©³ç´°ãƒœã‚¿ãƒ³ï¼‰

### 4. æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸ã®UI

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**:
- æ³¨æ–‡åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- æ±ºæ¸ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- åˆ¶ä½œé€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- é…é€æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒœã‚¿ãƒ³

## ğŸ“¡ ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. é¡§å®¢ä¸€è¦§ã®å–å¾—

```typescript
// ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®é¡§å®¢ä¸€è¦§
const customersQuery = query(
  collection(db, 'users'),
  where('tenant', '==', currentTenant),
  // ã¾ãŸã¯ where('tenants', 'array-contains', currentTenant),
  orderBy('createdAt', 'desc'),
  limit(50)
);
```

### 2. é¡§å®¢è©³ç´°æƒ…å ±ã®å–å¾—

```typescript
// é¡§å®¢åŸºæœ¬æƒ…å ±
const userDoc = await getDoc(doc(db, 'users', customerId));

// æ³¨æ–‡å±¥æ­´ï¼ˆemailã§ç´ä»˜ã‘ï¼‰
const ordersQuery = query(
  collection(db, 'orders'),
  where('email', '==', userEmail),
  orderBy('createdAt', 'desc')
);

// æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ï¼ˆownerUidã§ç´ä»˜ã‘ï¼‰
const memoriesQuery = query(
  collection(db, 'memories'),
  where('ownerUid', '==', customerId),
  orderBy('updatedAt', 'desc')
);

// è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ï¼ˆemailã§ç´ä»˜ã‘ï¼‰
const claimRequestsQuery = query(
  collection(db, 'claimRequests'),
  where('email', '==', userEmail),
  orderBy('createdAt', 'desc')
);
```

### 3. å…¬é–‹ãƒšãƒ¼ã‚¸URLã®å–å¾—

```typescript
// æ³¨æ–‡ã‹ã‚‰å…¬é–‹ãƒšãƒ¼ã‚¸URLã‚’å–å¾—
const order = await getDoc(doc(db, 'orders', orderId));
const memoryId = order.data()?.memoryId;

if (memoryId) {
  const memory = await getDoc(doc(db, 'memories', memoryId));
  const publicPageId = memory.data()?.publicPageId;
  
  if (publicPageId) {
    const publicPage = await getDoc(doc(db, 'publicPages', publicPageId));
    // publicPageUrlã¯ claimRequests ã¾ãŸã¯ orders ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§
    // ã¾ãŸã¯ generatePublicPageUrl() ã§ç”Ÿæˆ
  }
}
```

## ğŸ”Œ NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½ã®è©³ç´°å®Ÿè£…

### 1. Web NFC APIã®å®Ÿè£…

```typescript
// src/lib/nfc/writer.ts
export interface NFCWriteOptions {
  url: string;
  onSuccess?: () => void;
  onError?: (error: Error) => void;
}

export async function writeNFCUrl(options: NFCWriteOptions): Promise<void> {
  const { url, onSuccess, onError } = options;
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
  if (!('NDEFWriter' in window)) {
    const error = new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯NFCæ›¸ãè¾¼ã¿ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome 89ä»¥é™ã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚');
    onError?.(error);
    throw error;
  }
  
  // HTTPSãƒã‚§ãƒƒã‚¯
  if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
    const error = new Error('NFCæ›¸ãè¾¼ã¿ã«ã¯HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚');
    onError?.(error);
    throw error;
  }
  
  try {
    const writer = new NDEFWriter();
    
    // NDEFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const message = {
      records: [
        {
          recordType: 'url',
          data: url
        }
      ]
    };
    
    // æ›¸ãè¾¼ã¿å®Ÿè¡Œ
    await writer.write(message);
    
    console.log('NFCæ›¸ãè¾¼ã¿æˆåŠŸ:', url);
    onSuccess?.();
  } catch (error: any) {
    console.error('NFCæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•´å½¢
    let errorMessage = 'NFCæ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    if (error.name === 'NotAllowedError') {
      errorMessage = 'NFCæ›¸ãè¾¼ã¿ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    } else if (error.name === 'NotSupportedError') {
      errorMessage = 'ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯NFCæ›¸ãè¾¼ã¿ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
    } else if (error.name === 'AbortError') {
      errorMessage = 'NFCæ›¸ãè¾¼ã¿ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
    }
    
    const formattedError = new Error(errorMessage);
    onError?.(formattedError);
    throw formattedError;
  }
}
```

### 2. NFCæ›¸ãè¾¼ã¿UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// src/components/nfc-writer-button.tsx
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Loader2, Radio, CheckCircle, XCircle } from 'lucide-react';
import { writeNFCUrl } from '@/lib/nfc/writer';

interface NFCWriterButtonProps {
  url: string;
  orderId?: string;
  onSuccess?: () => void;
  className?: string;
}

export function NFCWriterButton({ url, orderId, onSuccess, className }: NFCWriterButtonProps) {
  const [isWriting, setIsWriting] = useState(false);
  const [status, setStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  
  const handleWrite = async () => {
    setIsWriting(true);
    setStatus('idle');
    setErrorMessage(null);
    
    try {
      await writeNFCUrl({
        url,
        onSuccess: () => {
          setStatus('success');
          setIsWriting(false);
          
          // æ›¸ãè¾¼ã¿å±¥æ­´ã‚’è¨˜éŒ²
          if (orderId) {
            // orders.nfc ã‚’æ›´æ–°
            // updateOrderNFCStatus(orderId, currentUser.uid);
          }
          
          // æˆåŠŸã‚¢ãƒŠã‚¦ãƒ³ã‚¹
          if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('æ›¸ãè¾¼ã¿ãŒæˆåŠŸã—ã¾ã—ãŸï¼');
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
          }
          
          onSuccess?.();
          
          // 3ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
          setTimeout(() => {
            setStatus('idle');
          }, 3000);
        },
        onError: (error) => {
          setStatus('error');
          setErrorMessage(error.message);
          setIsWriting(false);
        }
      });
    } catch (error: any) {
      setStatus('error');
      setErrorMessage(error.message || 'NFCæ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      setIsWriting(false);
    }
  };
  
  return (
    <div className={className}>
      <Button
        onClick={handleWrite}
        disabled={isWriting || status === 'success'}
        className="w-full"
        variant={status === 'success' ? 'default' : 'outline'}
      >
        {isWriting ? (
          <>
            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            NFCã‚¿ã‚°ã‚’è¿‘ã¥ã‘ã¦ãã ã•ã„...
          </>
        ) : status === 'success' ? (
          <>
            <CheckCircle className="w-4 h-4 mr-2" />
            æ›¸ãè¾¼ã¿æˆåŠŸï¼
          </>
        ) : status === 'error' ? (
          <>
            <XCircle className="w-4 h-4 mr-2" />
            æ›¸ãè¾¼ã¿å¤±æ•—
          </>
        ) : (
          <>
            <Radio className="w-4 h-4 mr-2" />
            NFCæ›¸ãè¾¼ã¿
          </>
        )}
      </Button>
      
      {errorMessage && (
        <p className="mt-2 text-sm text-red-600">{errorMessage}</p>
      )}
      
      {status === 'success' && (
        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
          <p className="text-green-800 font-semibold">
            âœ… æ›¸ãè¾¼ã¿ãŒæˆåŠŸã—ã¾ã—ãŸï¼
          </p>
          <p className="text-sm text-green-600 mt-1">
            NFCã‚¿ã‚°ã«å…¬é–‹ãƒšãƒ¼ã‚¸URLãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã—ãŸã€‚
          </p>
        </div>
      )}
    </div>
  );
}
```

### 3. æ›¸ãè¾¼ã¿å±¥æ­´ã®è¨˜éŒ²

```typescript
// src/lib/firestore.ts ã«è¿½åŠ 
export async function updateOrderNFCStatus(
  orderId: string,
  operatorUid: string,
  publicPageUrl: string
): Promise<void> {
  const orderRef = doc(db, 'orders', orderId);
  await updateDoc(orderRef, {
    'nfc.written': true,
    'nfc.writtenAt': serverTimestamp(),
    'nfc.operator': operatorUid,
    'nfc.url': publicPageUrl,
    updatedAt: serverTimestamp(),
  });
}
```

## ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ

### AdminLayoutã¸ã®è¿½åŠ 

```typescript
// src/components/admin-layout.tsx ã‚’æ›´æ–°
const adminNavItems: NavItem[] = [
  {
    title: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
    href: '/dashboard',
    icon: LayoutDashboard,
  },
  {
    title: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†',
    href: '/admin/users',
    icon: Users,
  },
  {
    title: 'CRM',
    href: '/admin/crm',
    icon: FileText, // ã¾ãŸã¯å°‚ç”¨ã‚¢ã‚¤ã‚³ãƒ³
  },
  {
    title: 'æ³¨æ–‡ç®¡ç†',
    href: '/orders',
    icon: FileText,
  },
];
```

### CRMãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸

```typescript
// src/app/admin/crm/page.tsx
- CRMæ©Ÿèƒ½ã®æ¦‚è¦
- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
  - é¡§å®¢ä¸€è¦§ã¸
  - æ³¨æ–‡ä¸€è¦§ã¸
  - NFCæ›¸ãè¾¼ã¿ã¸
- çµ±è¨ˆæƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:
  - ä»Šæ—¥ã®æ³¨æ–‡æ•°
  - é…é€å¾…ã¡æ³¨æ–‡æ•°
  - NFCæ›¸ãè¾¼ã¿å¾…ã¡æ³¨æ–‡æ•°
```

## ğŸ”’ Firestore Rulesã®æ›´æ–°

```javascript
// firestore.rules ã«è¿½åŠ 
match /orders/{orderId} {
  // fulfillmentOperatorã¯æ³¨æ–‡æƒ…å ±ã®é–²è¦§ãƒ»æ›´æ–°ãŒå¯èƒ½
  allow read, update: if request.auth != null && 
    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'fulfillmentOperator' ||
     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'tenantAdmin' ||
     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin');
}

match /claimRequests/{requestId} {
  // fulfillmentOperatorã¯è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é–²è¦§ãŒå¯èƒ½
  allow read: if request.auth != null && 
    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'fulfillmentOperator' ||
     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'tenantAdmin' ||
     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin');
}
```

## ğŸ¯ å®Ÿè£…ã®å„ªå…ˆé †ä½ï¼ˆè©³ç´°ç‰ˆï¼‰

### Phase 1: æ¨©é™ç®¡ç†ã®å¼·åŒ–ï¼ˆ1-2æ—¥ï¼‰

1. **æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®å®Ÿè£…**
   - `src/lib/security/role-check.ts` ã‚’ä½œæˆ
   - `canAccessCRM()`, `canWriteNFC()` é–¢æ•°ã‚’å®Ÿè£…
   - ãƒ†ã‚¹ãƒˆ: å„ãƒ­ãƒ¼ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª

2. **èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ‹¡å¼µ**
   - `useSecretKeyAuth` ã« `canAccessCRM` ã‚’è¿½åŠ 
   - CRMãƒšãƒ¼ã‚¸ã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯

3. **Firestore Rulesã®æ›´æ–°**
   - `fulfillmentOperator` ãƒ­ãƒ¼ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¿½åŠ 
   - ãƒ†ã‚¹ãƒˆ: å„ãƒ­ãƒ¼ãƒ«ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª

### Phase 2: é¡§å®¢ç®¡ç†æ©Ÿèƒ½ï¼ˆ3-5æ—¥ï¼‰

1. **é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸** (`/admin/crm/customers`)
   - ãƒšãƒ¼ã‚¸ä½œæˆ
   - ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»è¡¨ç¤º
   - æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ†ã‚¹ãƒˆ: ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã€æ¤œç´¢ã€ãƒ•ã‚£ãƒ«ã‚¿ã®å‹•ä½œç¢ºèª

2. **é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸** (`/admin/crm/customers/[customerId]`)
   - ãƒšãƒ¼ã‚¸ä½œæˆ
   - é¡§å®¢åŸºæœ¬æƒ…å ±ã®è¡¨ç¤º
   - æ³¨æ–‡å±¥æ­´ã®è¡¨ç¤º
   - æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ä¸€è¦§ã®è¡¨ç¤º
   - è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ã®è¡¨ç¤º
   - ãƒ†ã‚¹ãƒˆ: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç¢ºèª

### Phase 3: æ³¨æ–‡ç®¡ç†æ©Ÿèƒ½ï¼ˆ3-5æ—¥ï¼‰

1. **æ³¨æ–‡ä¸€è¦§ãƒšãƒ¼ã‚¸** (`/admin/crm/orders`)
   - ãƒšãƒ¼ã‚¸ä½œæˆ
   - ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»è¡¨ç¤º
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
   - æ¤œç´¢æ©Ÿèƒ½
   - ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
   - ãƒ†ã‚¹ãƒˆ: ãƒ•ã‚£ãƒ«ã‚¿ã€æ¤œç´¢ã€ã‚½ãƒ¼ãƒˆã®å‹•ä½œç¢ºèª

2. **æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸** (`/admin/crm/orders/[orderId]`)
   - ãƒšãƒ¼ã‚¸ä½œæˆ
   - æ³¨æ–‡æƒ…å ±ã®è¡¨ç¤º
   - æ±ºæ¸ˆæƒ…å ±ã®ç¢ºèª
   - åˆ¶ä½œé€²æ—ã®ç¢ºèª
   - é…é€æƒ…å ±ã®è¡¨ç¤ºãƒ»æ›´æ–°
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ©Ÿèƒ½
   - ãƒ†ã‚¹ãƒˆ: æƒ…å ±è¡¨ç¤ºã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã®å‹•ä½œç¢ºèª

### Phase 4: NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½ï¼ˆ2-3æ—¥ï¼‰

1. **NFCæ›¸ãè¾¼ã¿ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**
   - `src/lib/nfc/writer.ts` ã‚’ä½œæˆ
   - Web NFC APIã®çµ±åˆ
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   - ãƒ†ã‚¹ãƒˆ: å®Ÿéš›ã®NFCã‚¿ã‚°ã§ã®æ›¸ãè¾¼ã¿ç¢ºèª

2. **NFCæ›¸ãè¾¼ã¿UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
   - `src/components/nfc-writer-button.tsx` ã‚’ä½œæˆ
   - æ›¸ãè¾¼ã¿ä¸­ã®çŠ¶æ…‹è¡¨ç¤º
   - æˆåŠŸãƒ»å¤±æ•—ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
   - ãƒ†ã‚¹ãƒˆ: UIã®å‹•ä½œç¢ºèª

3. **é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®çµ±åˆ**
   - NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³ã®è¿½åŠ 
   - æ›¸ãè¾¼ã¿å±¥æ­´ã®è¨˜éŒ²
   - ãƒ†ã‚¹ãƒˆ: ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª

## ğŸ› ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### NFCæ›¸ãè¾¼ã¿ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

1. **ãƒ–ãƒ©ã‚¦ã‚¶æœªå¯¾å¿œ**
   - ã‚¨ãƒ©ãƒ¼: `NotSupportedError`
   - å¯¾å¿œ: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º + Chrome 89ä»¥é™ã®ä½¿ç”¨ã‚’æ¡ˆå†…

2. **HTTPSæœªå¯¾å¿œ**
   - ã‚¨ãƒ©ãƒ¼: ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼
   - å¯¾å¿œ: HTTPSç’°å¢ƒãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã‚’æ¡ˆå†…

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨±å¯ãªã—**
   - ã‚¨ãƒ©ãƒ¼: `NotAllowedError`
   - å¯¾å¿œ: ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§ã®è¨±å¯ã‚’æ¡ˆå†…

4. **NFCã‚¿ã‚°æœªæ¤œå‡º**
   - ã‚¨ãƒ©ãƒ¼: `AbortError` ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
   - å¯¾å¿œ: NFCã‚¿ã‚°ã‚’è¿‘ã¥ã‘ã‚‹ã‚ˆã†æ¡ˆå†…

5. **æ›¸ãè¾¼ã¿å¤±æ•—**
   - ã‚¨ãƒ©ãƒ¼: ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
   - å¯¾å¿œ: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º + å†è©¦è¡Œãƒœã‚¿ãƒ³

## ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

- ãƒ¢ãƒã‚¤ãƒ«: ã‚«ãƒ¼ãƒ‰å½¢å¼ã®ä¸€è¦§è¡¨ç¤º
- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 3-4ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

## ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½

### é¡§å®¢ä¸€è¦§ã®æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿

- **æ¤œç´¢**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€è¡¨ç¤ºåï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
- **ãƒ•ã‚£ãƒ«ã‚¿**: 
  - ãƒ†ãƒŠãƒ³ãƒˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
  - ä½œæˆæ—¥ï¼ˆæœŸé–“æŒ‡å®šï¼‰
  - æ³¨æ–‡æœ‰ç„¡

### æ³¨æ–‡ä¸€è¦§ã®æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿

- **æ¤œç´¢**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€æ³¨æ–‡IDï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
- **ãƒ•ã‚£ãƒ«ã‚¿**: 
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ±ºæ¸ˆå®Œäº†ã€åˆ¶ä½œä¸­ã€é…é€å¾…ã¡ã€é…é€æ¸ˆã¿ï¼‰
  - æ±ºæ¸ˆæ—¥ï¼ˆæœŸé–“æŒ‡å®šï¼‰
  - å•†å“ã‚¿ã‚¤ãƒ—

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

1. **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: 50ä»¶/ãƒšãƒ¼ã‚¸
2. **ãƒ‡ãƒ¼ã‚¿ã®é…å»¶èª­ã¿è¾¼ã¿**: ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: React Queryã§ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
4. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é©åˆ‡ãªè¨­å®š

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### å˜ä½“ãƒ†ã‚¹ãƒˆ

1. æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
2. NFCæ›¸ãè¾¼ã¿é–¢æ•°ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
3. ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ

### çµ±åˆãƒ†ã‚¹ãƒˆ

1. é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª
2. é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª
3. æ³¨æ–‡ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª
4. æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª

### E2Eãƒ†ã‚¹ãƒˆ

1. NFCæ›¸ãè¾¼ã¿ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
2. æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å‹•ä½œç¢ºèª
3. ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®æ­£ç¢ºæ€§ç¢ºèª

## ğŸ“š å‚è€ƒè³‡æ–™

- [CRM_DATABASE_STRUCTURE.md](../specifications/CRM_DATABASE_STRUCTURE.md)
- [Web NFC API Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Web_NFC_API)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [React Query Documentation](https://tanstack.com/query/latest)

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: æ¨©é™ç®¡ç†ã®å¼·åŒ–

- [ ] `src/lib/security/role-check.ts` ã‚’ä½œæˆ
- [ ] `canAccessCRM()` é–¢æ•°ã‚’å®Ÿè£…
- [ ] `canWriteNFC()` é–¢æ•°ã‚’å®Ÿè£…
- [ ] `useSecretKeyAuth` ã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
- [ ] Firestore Rulesã‚’æ›´æ–°
- [ ] æ¨©é™ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½

### Phase 2: é¡§å®¢ç®¡ç†æ©Ÿèƒ½

- [ ] `/admin/crm/customers/page.tsx` ã‚’ä½œæˆ
- [ ] é¡§å®¢ä¸€è¦§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’å®Ÿè£…
- [ ] æ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…
- [ ] ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã‚’å®Ÿè£…
- [ ] ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…
- [ ] `/admin/crm/customers/[customerId]/page.tsx` ã‚’ä½œæˆ
- [ ] é¡§å®¢åŸºæœ¬æƒ…å ±ã®è¡¨ç¤ºã‚’å®Ÿè£…
- [ ] æ³¨æ–‡å±¥æ­´ã®è¡¨ç¤ºã‚’å®Ÿè£…
- [ ] æƒ³ã„å‡ºãƒšãƒ¼ã‚¸ä¸€è¦§ã®è¡¨ç¤ºã‚’å®Ÿè£…
- [ ] è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ã®è¡¨ç¤ºã‚’å®Ÿè£…
- [ ] UIãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½

### Phase 3: æ³¨æ–‡ç®¡ç†æ©Ÿèƒ½

- [ ] `/admin/crm/orders/page.tsx` ã‚’ä½œæˆ
- [ ] æ³¨æ–‡ä¸€è¦§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’å®Ÿè£…
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚’å®Ÿè£…
- [ ] æ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…
- [ ] ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…
- [ ] `/admin/crm/orders/[orderId]/page.tsx` ã‚’ä½œæˆ
- [ ] æ³¨æ–‡æƒ…å ±ã®è¡¨ç¤ºã‚’å®Ÿè£…
- [ ] æ±ºæ¸ˆæƒ…å ±ã®ç¢ºèªã‚’å®Ÿè£…
- [ ] åˆ¶ä½œé€²æ—ã®ç¢ºèªã‚’å®Ÿè£…
- [ ] é…é€æƒ…å ±ã®è¡¨ç¤ºãƒ»æ›´æ–°ã‚’å®Ÿè£…
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…
- [ ] UIãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½

### Phase 4: NFCæ›¸ãè¾¼ã¿æ©Ÿèƒ½

- [ ] `src/lib/nfc/writer.ts` ã‚’ä½œæˆ
- [ ] Web NFC APIã®çµ±åˆã‚’å®Ÿè£…
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…
- [ ] `src/components/nfc-writer-button.tsx` ã‚’ä½œæˆ
- [ ] æ›¸ãè¾¼ã¿ä¸­ã®çŠ¶æ…‹è¡¨ç¤ºã‚’å®Ÿè£…
- [ ] æˆåŠŸãƒ»å¤±æ•—ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’å®Ÿè£…
- [ ] é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã«NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
- [ ] æ›¸ãè¾¼ã¿å±¥æ­´ã®è¨˜éŒ²ã‚’å®Ÿè£…
- [ ] å®Ÿéš›ã®NFCã‚¿ã‚°ã§ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½

### çµ±åˆãƒ»æœ€çµ‚ç¢ºèª

- [ ] AdminLayoutã«CRMãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
- [ ] `/admin/crm` ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

## âš ï¸ æ³¨æ„äº‹é …

### 1. ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢

- ã™ã¹ã¦ã®CRMæ©Ÿèƒ½ã§ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã‚’å®Ÿæ–½
- `getCurrentTenant()` ã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒŠãƒ³ãƒˆã‚’å–å¾—
- Firestoreã‚¯ã‚¨ãƒªã«å¿…ãšãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ 

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- ã™ã¹ã¦ã®CRMãƒšãƒ¼ã‚¸ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½
- é¡§å®¢æƒ…å ±ã®é©åˆ‡ãªä¿è­·
- NFCæ›¸ãè¾¼ã¿æ“ä½œã®ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—æ™‚ã¯ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…
- React Queryã§ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨
- ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é¿ã‘ã‚‹

### 4. NFCæ›¸ãè¾¼ã¿

- Chrome 89ä»¥é™ã§ã®ã¿å‹•ä½œ
- HTTPSç’°å¢ƒãŒå¿…è¦
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨±å¯ãŒå¿…è¦
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é©åˆ‡ã«å®Ÿè£…

### 5. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

- `orders.memoryId` ã¨ `memories.id` ã®æ•´åˆæ€§ç¢ºèª
- `publicPages.memoryId` ã¨ `memories.id` ã®æ•´åˆæ€§ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## ğŸ”„ æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®çµ±åˆ

### 1. AdminLayoutã®æ›´æ–°

æ—¢å­˜ã® `AdminLayout` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«CRMãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

### 2. èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ‹¡å¼µ

æ—¢å­˜ã® `useSecretKeyAuth` ã«æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

### 3. Firestore Rulesã®æ›´æ–°

æ—¢å­˜ã® `firestore.rules` ã« `fulfillmentOperator` ãƒ­ãƒ¼ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¿½åŠ ã—ã¾ã™ã€‚

### 4. å‹å®šç¾©ã®ç¢ºèª

æ—¢å­˜ã® `src/types/index.ts` ã«å¿…è¦ãªå‹å®šç¾©ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

## ğŸ“ å®Ÿè£…æ™‚ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

1. **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‘½å**: PascalCaseï¼ˆä¾‹: `NFCWriterButton`ï¼‰
2. **é–¢æ•°å‘½å**: camelCaseï¼ˆä¾‹: `writeNFCUrl`ï¼‰
3. **ãƒ•ã‚¡ã‚¤ãƒ«å‘½å**: kebab-caseï¼ˆä¾‹: `nfc-writer-button.tsx`ï¼‰
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: try-catch ã§é©åˆ‡ã«å‡¦ç†
5. **ãƒ­ã‚°å‡ºåŠ›**: é–‹ç™ºæ™‚ã¯ `console.log`ã€æœ¬ç•ªã§ã¯å‰Šé™¤ã¾ãŸã¯æœ€å°åŒ–

## ğŸ¯ æˆåŠŸåŸºæº–

### Phase 1å®Œäº†åŸºæº–

- æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- å„ãƒ­ãƒ¼ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒé©åˆ‡ã«åˆ¶å¾¡ã•ã‚Œã‚‹

### Phase 2å®Œäº†åŸºæº–

- é¡§å®¢ä¸€è¦§ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãŒå‹•ä½œã™ã‚‹
- é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã§å¿…è¦ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### Phase 3å®Œäº†åŸºæº–

- æ³¨æ–‡ä¸€è¦§ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãŒå‹•ä½œã™ã‚‹
- æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸ã§å¿…è¦ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãŒå‹•ä½œã™ã‚‹

### Phase 4å®Œäº†åŸºæº–

- NFCæ›¸ãè¾¼ã¿ãŒå®Ÿéš›ã®NFCã‚¿ã‚°ã§å‹•ä½œã™ã‚‹
- æˆåŠŸãƒ»å¤±æ•—ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- æ›¸ãè¾¼ã¿å±¥æ­´ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹

## â“ ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆFAQï¼‰

### Q1: NFCæ›¸ãè¾¼ã¿ã¯ã©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã¾ã™ã‹ï¼Ÿ

A: Chrome 89ä»¥é™ã€Androidç‰ˆChromeã§å‹•ä½œã—ã¾ã™ã€‚Safariã‚„Firefoxã§ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

### Q2: NFCæ›¸ãè¾¼ã¿ã«ã¯ã©ã®ã‚ˆã†ãªç’°å¢ƒãŒå¿…è¦ã§ã™ã‹ï¼Ÿ

A: 
- HTTPSç’°å¢ƒï¼ˆlocalhostã¯é™¤ãï¼‰
- NFCå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã€ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼‰
- NFCã‚¿ã‚°ï¼ˆNTAG213ä»¥ä¸Šæ¨å¥¨ï¼‰

### Q3: é¡§å®¢æƒ…å ±ã¯ã©ã®ã‚ˆã†ã«ä¿è­·ã•ã‚Œã¾ã™ã‹ï¼Ÿ

A: 
- Firestore Rulesã§ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢
- æ¨©é™ãƒã‚§ãƒƒã‚¯ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã®ãƒšãƒ¼ã‚¸

### Q4: å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯ï¼Ÿ

A: 
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ50ä»¶/ãƒšãƒ¼ã‚¸ï¼‰ã‚’å®Ÿè£…
- React Queryã§ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- å¿…è¦ã«å¿œã˜ã¦Cloud Functionsã§é›†è¨ˆå‡¦ç†

### Q5: NFCæ›¸ãè¾¼ã¿ãŒå¤±æ•—ã—ãŸå ´åˆã®å¯¾å‡¦æ³•ã¯ï¼Ÿ

A: 
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
- å†è©¦è¡Œãƒœã‚¿ãƒ³ã‚’æä¾›
- ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã™ã‚‹ã‚ˆã†æ¡ˆå†…

## ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆ

### 1. ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æœ€é©åŒ–

```typescript
// è¤‡æ•°ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆ
// Promise.all ã‚’ä½¿ç”¨ã—ã¦ä¸¦åˆ—å–å¾—
const [user, orders, memories] = await Promise.all([
  getDoc(doc(db, 'users', customerId)),
  getDocs(query(collection(db, 'orders'), where('email', '==', userEmail))),
  getDocs(query(collection(db, 'memories'), where('ownerUid', '==', customerId)))
]);
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

```typescript
// å…±é€šã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°
function handleError(error: any, context: string) {
  console.error(`[${context}] Error:`, error);
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
  if (error.code === 'permission-denied') {
    return 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
  }
  return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
}
```

### 3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†

```typescript
// React Queryã‚’ä½¿ç”¨ã—ãŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†
const { data, isLoading, error } = useQuery({
  queryKey: ['customers', tenant],
  queryFn: () => fetchCustomers(tenant),
  staleTime: 5 * 60 * 1000, // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
});
```

### 4. ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validateOrderStatusUpdate(
  currentStatus: string,
  newStatus: string
): boolean {
  const allowedTransitions: Record<string, string[]> = {
    'paid': ['nfcReady', 'shipped'],
    'nfcReady': ['shipped'],
    'shipped': ['delivered'],
  };
  
  return allowedTransitions[currentStatus]?.includes(newStatus) ?? false;
}
```

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå‚è€ƒï¼‰

- `src/app/admin/users/page.tsx` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆå‚è€ƒå®Ÿè£…ï¼‰
- `src/app/admin/tenants/page.tsx` - ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆå‚è€ƒå®Ÿè£…ï¼‰
- `src/components/admin-layout.tsx` - ç®¡ç†ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- `src/contexts/secret-key-auth-context.tsx` - èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- `src/lib/firestore.ts` - Firestoreæ“ä½œé–¢æ•°
- `src/lib/security/tenant-validation.ts` - ãƒ†ãƒŠãƒ³ãƒˆæ¤œè¨¼

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«

- `src/lib/security/role-check.ts` - æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
- `src/lib/nfc/writer.ts` - NFCæ›¸ãè¾¼ã¿é–¢æ•°
- `src/components/nfc-writer-button.tsx` - NFCæ›¸ãè¾¼ã¿ãƒœã‚¿ãƒ³
- `src/app/admin/crm/customers/page.tsx` - é¡§å®¢ä¸€è¦§ãƒšãƒ¼ã‚¸
- `src/app/admin/crm/customers/[customerId]/page.tsx` - é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸
- `src/app/admin/crm/orders/page.tsx` - æ³¨æ–‡ä¸€è¦§ãƒšãƒ¼ã‚¸
- `src/app/admin/crm/orders/[orderId]/page.tsx` - æ³¨æ–‡è©³ç´°ãƒšãƒ¼ã‚¸

## ğŸ“‹ å®Ÿè£…å‰ã®ç¢ºèªäº‹é …

1. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
   - Firebaseè¨­å®šãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
   - å¿…è¦ãªAPIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

2. **Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèª**
   - è¤‡åˆã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦
   - `firestore.indexes.json` ã‚’ç¢ºèª

3. **æ¨©é™è¨­å®šã®ç¢ºèª**
   - `fulfillmentOperator` ãƒ­ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹
   - Firestore RulesãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

4. **NFCå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®æº–å‚™**
   - ãƒ†ã‚¹ãƒˆç”¨ã®NFCã‚¿ã‚°ã‚’æº–å‚™
   - Chrome 89ä»¥é™ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æº–å‚™

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆæ¨©é™ã€ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®å‹•ä½œç¢ºèªï¼‰
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç¢ºèª
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã®ç¢ºèªï¼ˆç‰¹ã«NFCæ©Ÿèƒ½ï¼‰
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

---

**ä½œæˆæ—¥**: 2025-01-26  
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-01-26  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1

