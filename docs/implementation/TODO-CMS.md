# TODO-CMS.md

## 📋 CMS実装状況と今後のタスク（最新版）

**最終更新**: 2025年1月  
**バージョン**: v2.3

このドキュメントは、CMS側の実装状況と今後のタスクを管理するための統合ドキュメントです。

---

## ✅ 実装完了した機能

### Phase 1: 基本機能

#### ユーザー管理画面 (`/admin/users`)
- ✅ ユーザー一覧表示
- ✅ ステータス管理
- ✅ テナントフィルタ
- ✅ 一括操作

#### 想い出ページ作成 (`/memories/create`)
- ✅ タイトル・説明文の入力
- ✅ 画像・動画・音声アップロード（Firebase Storage）
- ✅ アルバム機能
  - アルバム作成
  - 写真の追加・削除
  - 順序変更
- ✅ コンテンツブロック管理
- ✅ ドラッグ&ドロップによる順序変更

#### メモリー管理画面 (`/dashboard`)
- ✅ 統計表示（総数、公開済み、下書き）
- ✅ 検索機能（タイトル）
- ✅ フィルタ機能（ステータス、タイプ）
- ✅ バルク操作
  - 選択モード（複数選択）
  - 全選択/全解除
  - 一括公開
  - 一括非公開
  - 一括削除
- ✅ クイック編集
  - 公開/非公開切り替え
  - 削除
  - 編集ページへの遷移

#### テナント管理 (`/admin/tenants`)
- ✅ テナント一覧表示
- ✅ 新規作成・編集
- ✅ ステータス管理（active/inactive/suspended）
- ✅ 設定画面へのリンク

#### 注文管理 (`/orders`)
- ✅ 注文一覧表示
- ✅ 注文詳細表示
- ✅ ステータス更新
- ✅ 写真アップロード（アクリルスタンド用）
- ✅ 配送先住所設定

### セキュリティ機能
- ✅ **Originベースのテナント検証**
  - `getTenantFromOrigin()` 関数実装
  - APIエンドポイントでの検証
  - クライアントからのtenant/lpIdを無視
  
- ✅ **テナント間のデータ分離**
  - 全てのクエリでテナントフィルタリング
  - Firestore Rulesでの制御
  - 異なるテナント間でのデータアクセス防止
  
- ✅ **reCAPTCHA検証**
  - Google reCAPTCHA v3の実装
  - スコア検証（0.5未満は拒否）

### その他の実装済み機能
- ✅ **クレーム処理** (`/claim`)
  - JWT検証
  - ClaimRequest取得・更新
  - メモリー自動作成
  - エラーハンドリング（無効なリンク、期限切れ、重複使用）
  
- ✅ **公開ページ** (`/public/[pageId]`)
  - 公開ページの表示
  - レスポンシブデザイン
  - テーマ対応
  
- ✅ **認証システム**
  - 秘密鍵ベース認証
  - 開発用パスワード認証
  - セッション管理

---

## ❌ 未実装の機能

### Phase 2: 高度機能

#### NFCタグ管理
- ❌ タグ生成・割り当て
- ❌ QRコード生成・表示
- ❌ NFCタグとメモリーの紐付け

#### 制作管理
- ❌ 制作指示書作成
- ❌ 進捗管理（注文管理画面は実装済み）
- ❌ 配送管理（注文管理画面は実装済み）

### Phase 3: その他

#### プレビュー機能
- ❌ 完全なプレビュー表示（部分実装済み）

#### 通知システム
- ❌ 自動通知
- ❌ メール通知

#### 分析機能
- ❌ ダッシュボードの分析機能拡張
- ❌ アクセス統計

---

## 🔄 仕様変更された機能

### 認証方式
- **変更前**: Firebase Auth パスワードレス認証（メールリンク）
- **変更後**: 秘密鍵ベース認証 + 開発用パスワード認証
- **理由**: LP経由（`/claim`）でのみメール認証を行い、CMS側は秘密鍵認証を使用

### トップページ
- **変更前**: 編集可能なランディングページ
- **変更後**: シンプルなランディングページ（編集機能削除）
- **理由**: メモリー作成は`/memories/create`で行う仕様に統一

### メモリー作成制限
- **変更前**: 誰でも新規作成可能
- **変更後**: LP経由（`/claim`経由）でないと新規作成不可
- **理由**: セキュリティとデータ整合性のため

### 注文管理機能（specification v3.3に準拠）
- **変更前**: CMSフロントから注文ステータスを更新可能
- **変更後**: Functions API 経由のみ更新可能（フロントからの直接更新を禁止）
- **理由**: NFC書き込み・印刷・出荷を専用のNFC Writerアプリに委譲
- **実施内容**:
  - `updateOrderStatus()` 関数を削除
  - 注文ステータス更新のUIボタンを削除
  - `updateOrder()` 関数を無効化
  - 注文ステータスは参照のみ表示

---

## 📝 開発チェックリスト（LP連携）

### CMS側で実装が必要な項目（LP連携）
- [x] JWTトークン検証機能
- [x] Firebase Firestore 連携
- [x] クレームページ (`/claim`) の実装
- [x] 想い出ページ作成フォーム
- [x] テナント・プロダクトタイプ対応
- [x] エラーハンドリング
- [x] レスポンシブデザイン
- [ ] 動的ブランド対応（部分実装）

### テスト項目
- [x] メールリンクからの正常な遷移
- [x] JWTトークンの検証
- [x] 無効なリンクの処理
- [x] 期限切れリンクの処理
- [x] 重複使用の防止
- [x] 想い出ページ作成の完了
- [x] テナント別の設定適用
- [ ] プロダクトタイプ別の機能提供（部分実装）

---

## 🚀 今後の優先タスク

### 高優先度
1. **NFCタグ管理**
   - タグ生成機能
   - QRコード生成・表示
   - メモリーとの紐付け

2. **制作管理**
   - 制作指示書作成
   - 進捗管理の改善

### 中優先度
1. **プレビュー機能の改善**
   - 完全なプレビュー表示

2. **動的ブランド対応**
   - テナント別のブランドカラー適用

### 低優先度
1. **通知システム**
   - 自動通知機能

2. **分析機能**
   - ダッシュボードの分析機能拡張

---

## 📚 関連ドキュメント

- **`ui-design-progress.md`**: UI設計と実装進捗の詳細
- **`specification-v3.3.md`**: 最新の仕様書
- **`system-architecture.v4.2.md`**: システムアーキテクチャ
- **`TODO-CMS-v2.2.md`**: LP側の仕様まとめ（参照用）

---

## 📝 注意事項

1. **このドキュメント（`TODO-CMS.md`）が最新の実装状況管理用**
2. **実装完了した機能はチェックマーク（✅）で表示**
3. **未実装の機能は❌で表示**
4. **仕様変更は「仕様変更された機能」セクションに記録**

---

**最終更新**: 2025年1月

